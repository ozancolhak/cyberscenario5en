<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V4: Supply Chain Disaster Simulation</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/dracula.min.css">
    <style>
        :root {
            --dark-bg: #1a1a2e;
            --container-bg: #2a2a4a;
            --section-bg: #333355;
            --interactive-bg: #444466;
            --accent-blue: #8be9fd;
            --accent-purple: #bd93f9;
            --accent-pink: #ff79c6;
            --accent-green: #50fa7b;
            --accent-yellow: #f1fa8c;
            --accent-red: #ff5555;
            --text-light: #e0e0e0;
            --text-dark: #282a36;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        body { font-family: 'Roboto', sans-serif; background-color: var(--dark-bg); color: var(--text-light); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        .container { background-color: var(--container-bg); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); padding: 20px; max-width: 950px; width: 100%; margin: 40px 0; }
        @media (min-width: 768px) { .container { padding: 40px; } }
        .centered-page { display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; min-height: 60vh; animation: fadeIn 0.5s ease-out; }
        h1 { font-size: 2.5em; color: var(--accent-blue); margin-bottom: 20px; }
        h2 { font-size: 2em; color: var(--accent-blue); border-bottom: 2px solid var(--interactive-bg); padding-bottom: 15px; margin-bottom: 25px; }
        h3 { font-size: 1.5em; color: var(--accent-blue); }
        h4 { font-size: 1.2em; color: var(--accent-purple); text-align: left; margin-top: 0; border-bottom: 1px solid var(--interactive-bg); padding-bottom: 10px; }
        p { line-height: 1.7; font-size: 1.1em; }
        .section { display: none; padding: 20px; background-color: var(--section-bg); border-radius: 8px; margin-top: 25px; animation: fadeIn 0.5s ease-out; }
        @media (min-width: 768px) { .section { padding: 30px; } }
        .interactive-element { background-color: var(--interactive-bg); border-radius: 8px; padding: 20px; margin-top: 20px; }
        .decision-buttons { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; }
        .btn { background-color: #6272a4; color: white; border: none; padding: 15px 25px; border-radius: 8px; cursor: pointer; font-size: 1.1em; transition: all 0.3s ease; text-align: left; display: flex; align-items: center; gap: 15px; font-weight: 700; }
        .btn:hover { background-color: #7a8ab9; transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .btn:disabled { background-color: #555 !important; color: #999 !important; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }
        .btn .btn-text { flex-grow: 1; }
        .btn small { display: block; font-size: 0.85em; opacity: 0.8; margin-top: 5px; font-weight: 400; }
        .btn-start, .btn-continue { font-size: 1.3em; font-weight: bold; text-align: center; background-color: var(--accent-green); color: var(--text-dark); justify-content: center; }
        #intermissionSection .metric-change { font-size: 1.2em; margin: 15px 0; display: flex; align-items: center; gap: 10px; }
        .metric-change .positive { color: var(--accent-green); }
        .metric-change .negative { color: var(--accent-red); }
        #statusBar { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 15px; background-color: var(--text-dark); padding: 15px; border-radius: 8px; margin-bottom: 25px; border: 1px solid #6272a4; }
        #statusBar .metric { text-align: center; font-size: 0.9em; }
        #statusBar .metric .value { font-size: 1.3em; font-weight: bold; color: var(--accent-yellow); }
        .final-metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-top: 20px; width: 100%; max-width: 850px; }
        .metric-card { background-color: var(--section-bg); padding: 25px; border-radius: 8px; text-align: center; border: 1px solid var(--interactive-bg); transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 150px; }
        .metric-card:hover { transform: scale(1.05); border-color: var(--accent-blue); }
        .metric-card .icon { font-size: 2.5em; color: var(--accent-blue); margin-bottom: 10px; }
        .metric-card .label { font-size: 1.1em; margin-bottom: 5px; color: var(--text-light); }
        .metric-card .value { font-size: 1.8em; font-weight: bold; color: var(--accent-yellow); }
        .code-block, .slack-chat { background-color: var(--text-dark); border: 1px solid #6272a4; border-radius: 8px; padding: 20px; margin-top: 15px; white-space: pre-wrap; word-break: break-all; font-family: 'Consolas', monospace; }
        .learning-note { background-color: var(--text-dark); border-left: 5px solid var(--accent-blue); padding: 20px; border-radius: 8px; margin-top: 30px; }
        .scenario-image { width: 100%; max-width: 500px; margin: 25px auto; display: block; border-radius: 8px; border: 1px solid var(--interactive-bg); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .slack-chat .message { margin-bottom: 10px; padding: 8px; border-radius: 5px; background-color: #3f3f5a; }
        .slack-chat .sender { font-weight: bold; color: var(--accent-pink); }
        .slack-chat .sender.cso { color: var(--accent-green); }
        .slack-chat .sender.ops { color: var(--accent-yellow); }
        .slack-chat .sender.legal { color: var(--accent-blue); }
        .slack-chat .sender.ceo { color: var(--accent-purple); }
        .suspect-card { background-color: var(--interactive-bg); border-radius: 8px; padding: 15px; margin-bottom: 10px; border-left: 5px solid var(--accent-purple); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .suspect-card h4 { margin-top: 0; margin-bottom: 5px; border-bottom: none; color: var(--accent-purple); }
        #finalSection { text-align: center; }
        #performance-badge-container { margin: 25px 0; }
        #performance-badge { padding: 12px 30px; font-size: 1.8em; font-weight: bold; border-radius: 50px; display: inline-block; color: var(--text-dark); box-shadow: 0 5px 20px rgba(0,0,0,0.4); transition: transform 0.3s ease; }
        #performance-badge:hover { transform: scale(1.05); }
        .post-crisis-layout { display: grid; grid-template-columns: 1fr; gap: 30px; text-align: left; margin-top: 40px; width: 100%; }
        @media (min-width: 800px) { .post-crisis-layout { grid-template-columns: 1fr 1fr; } }
        .event-timeline, .strategic-debrief { background-color: var(--interactive-bg); padding: 25px; border-radius: 8px; border: 1px solid var(--section-bg); margin-top: 20px; }
        .event-timeline h3, .strategic-debrief h3 { margin-top: 0; padding-bottom: 10px; border-bottom: 1px solid var(--section-bg); color: var(--accent-blue); display: flex; align-items: center; gap: 10px; }
        .event-timeline ul { list-style-type: none; padding-left: 0; margin: 15px 0 0 0; }
        .event-timeline li { position: relative; padding: 5px 0 15px 35px; border-left: 2px solid var(--section-bg); font-size: 0.95em; }
        .event-timeline li:last-child { border-left: none; }
        .event-timeline li::before { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: var(--accent-green); position: absolute; left: -12px; top: 5px; background-color: var(--dark-bg); width: 22px; height: 22px; border-radius: 50%; text-align: center; line-height: 22px; font-size: 0.8em; border: 2px solid var(--section-bg); }
        .event-timeline li.negative::before { content: '\f00d'; color: var(--accent-red); }
        .event-timeline li.neutral::before { content: '\f05a'; color: var(--accent-blue); }
        .event-timeline li .decision-title { font-weight: bold; color: var(--accent-purple); display: block; margin-bottom: 4px; }
        .event-timeline li .decision-impact { font-style: italic; opacity: 0.8; font-size: 0.9em; }
        #strategic-debrief-content p { font-size: 1em; margin-bottom: 15px; }
        #rolesInfo { background-color: var(--section-bg); border-radius: 8px; padding: 20px; margin-top: 30px; text-align: left; width: 100%; max-width: 600px; }
        #rolesInfo h3 { color: var(--accent-green); margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid var(--interactive-bg); padding-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        #rolesInfo ul { list-style-type: none; padding-left: 0; margin: 0; }
        #rolesInfo ul li { margin-bottom: 10px; padding-left: 25px; position: relative; }
        #rolesInfo ul li:last-child { margin-bottom: 0; }
        #rolesInfo ul li::before { content: '\f007'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: var(--accent-purple); position: absolute; left: 0; top: 3px; }
        #rolesInfo ul li.your-role::before { color: var(--accent-yellow); }
        #rolesInfo ul li strong { color: var(--accent-blue); }
        #score-breakdown { list-style: none; padding: 0; margin-top: 15px; text-align: left; }
        #score-breakdown li { padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; font-size: 1.05em; display: flex; justify-content: space-between; }
        #score-breakdown .score-plus { background-color: rgba(80, 250, 123, 0.1); border-left: 3px solid var(--accent-green); }
        #score-breakdown .score-minus { background-color: rgba(255, 85, 85, 0.1); border-left: 3px solid var(--accent-red); }
        #score-breakdown .score-neutral { background-color: rgba(139, 233, 253, 0.1); border-left: 3px solid var(--accent-blue); }
        #score-breakdown .score-value { font-weight: bold; }
        .lb-overlay{ display:none; position:fixed; inset:0; background: rgba(10,10,25,.7); -webkit-backdrop-filter: blur(4px); backdrop-filter: blur(4px); z-index:9999; align-items:center; justify-content:center; padding:20px; animation: fadeIn 0.3s ease-out; }
        .lb-modal{ background: linear-gradient(180deg, #2a2a4a 0%, #1f1f36 100%); color: var(--text-light); width:100%; max-width: 760px; border-radius:14px; padding:22px 22px 16px; border:1px solid rgba(255,255,255,.08); box-shadow: 0 18px 50px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.04); }
        .lb-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
        .lb-title{ display:flex; align-items:center; gap:10px; font-size:1.25em; font-weight:800; letter-spacing:.2px; color: var(--accent-yellow); }
        .lb-title i{ filter: drop-shadow(0 2px 6px rgba(0,0,0,.35)); }
        .lb-tablewrap{ margin-top:10px; max-height: 60vh; overflow:auto; border:1px solid var(--interactive-bg); border-radius:10px; box-shadow: inset 0 0 0 1px rgba(255,255,255,.02); }
        table.lb-table{ width:100%; border-collapse:collapse; font-size:.97em; }
        table.lb-table th, table.lb-table td{ padding:10px 12px; text-align:left; }
        table.lb-table thead th{ position: sticky; top:0; z-index:1; background:#1f1f36; color:#e9e9ff; border-bottom: 1px solid #3b3b66; font-weight:700; letter-spacing:.3px; }
        table.lb-table tbody td{ border-bottom:1px solid rgba(255,255,255,.06); color:#e9e9f5; }
        table.lb-table tbody tr:hover{ background-color: rgba(255,255,255,.045); }
        table.lb-table tbody tr:nth-child(1){ background: linear-gradient(90deg, rgba(255,215,0,.18), transparent 65%); }
        table.lb-table tbody tr:nth-child(1) td:first-child::after{ content:" ðŸ¥‡"; }
        table.lb-table tbody tr:nth-child(2){ background: linear-gradient(90deg, rgba(192,192,192,.18), transparent 65%); }
        table.lb-table tbody tr:nth-child(2) td:first-child::after{ content:" ðŸ¥ˆ"; }
        table.lb-table tbody tr:nth-child(3){ background: linear-gradient(90deg, rgba(205,127,50,.18), transparent 65%); }
        table.lb-table tbody tr:nth-child(3) td:first-child::after{ content:" ðŸ¥‰"; }
        .lb-actions{ display:flex; gap:12px; justify-content:flex-end; margin-top:14px; }
        .lb-close, .lb-refresh{ border:0; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:700; transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease; }
        .lb-refresh{ background: var(--accent-blue); color:#0c1130; }
        .lb-close{ background: #3d3d60; color:#fff; }
        .lb-refresh:hover{ transform: translateY(-1px); box-shadow: 0 8px 18px rgba(139,233,253,.22); }
        .lb-close:hover{ transform: translateY(-1px); box-shadow: 0 8px 18px rgba(0,0,0,.35); }
        @media (max-width: 420px){ .lb-title{ font-size:1.05em; } table.lb-table th, table.lb-table td{ padding:9px 10px; } }
    </style>
</head>
<body>
    <div class="container">
        <div id="introSection" class="centered-page">
            <h1><i class="fa-solid fa-user-secret"></i> Supply Chain Attack Simulation</h1>
            <p style="max-width: 600px;">Welcome, Cyber Threat Intelligence (CTI) Specialist! Today, you will confront a global supply chain disaster engulfing your company, **COLHAK Technology**. Backdoors, leaked data, and shaken customer trust... In this simulation, you will not only solve technical problems but also manage a complex cyber war using the power of strategic intelligence, determining the fate of the company. Are you ready?</p>
            <img src="images/intro_cyber.png" alt="A cyber security themed intro image" class="scenario-image">

            <div id="rolesInfo">
                <h3><i class="fa-solid fa-people-arrows"></i> Simulation Roles</h3>
                <ul>
                    <li class="your-role"><strong>Your Role: CTI Specialist</strong> - You are responsible for gathering, analyzing, and interpreting cyber threat intelligence, and guiding the crisis team. Your choices will directly impact the outcome.</li>
                    <li><strong>CEO Elara YÄ±lmaz</strong> - The company's top executive, focused on overall business continuity and public perception.</li>
                    <li><strong>CSO Can Demir</strong> - Responsible for cybersecurity operations and defense strategies.</li>
                    <li><strong>Legal Counsel Zeynep Kaya</strong> - Oversees legal compliance and advises on public statements to mitigate legal risks.</li>
                    <li><strong>Operations Director Levent AkÄ±n</strong> - Concerned about customer service and business continuity.</li>
                    <li><strong>Supplier Relations Manager Dr. Aylin GÃ¼neÅŸ</strong> - Manages relationships with suppliers and assesses their reliability.</li>
                </ul>
            </div>

            <button class="btn btn-start" id="startButton"><i class="fa-solid fa-play"></i> Start Simulation</button>
        </div>

        <div id="intermissionSection" class="centered-page" style="display: none;">
            <h2 id="intermissionTitle"></h2>
            <p id="intermissionText" style="max-width: 600px;"></p>
            <div class="interactive-element" style="width: 100%; max-width: 500px;">
                <h4>Decision Impacts</h4>
                <div id="intermissionMetrics"></div>
            </div>
            <div class="interactive-element" style="width: 100%; max-width: 500px; border-left-color: var(--accent-blue); margin-top: 20px;">
                <h4>Strategic Assessment</h4>
                <p id="strategicText" style="font-size: 1em;"></p>
            </div>
            <button class="btn btn-continue" id="continueButton" style="margin-top: 30px;"><i class="fa-solid fa-forward"></i> Continue</button>
        </div>

        <div id="gameContainer" style="display: none;">
            <div id="statusBar">
                <div class="metric"><span><i class="fa-solid fa-triangle-exclamation"></i> Affected Systems</span><div class="value" id="status-affectedSystems">0</div></div>
                <div class="metric"><span><i class="fa-solid fa-hand-holding-dollar"></i> Financial Loss</span><div class="value" id="status-financialLoss">$0</div></div>
                <div class="metric"><span><i class="fa-solid fa-database"></i> Data Leak</span><div class="value" id="status-dataLeak">0%</div></div>
                <div class="metric"><span><i class="fa-solid fa-building-shield"></i> Reputation Score</span><div class="value" id="status-reputation">100</div></div>
                <div class="metric"><span><i class="fa-solid fa-clock"></i> Time Left</span><div class="value" id="status-timer">05:00</div></div>
            </div>
            <div id="game-content">
            </div>
        </div>
    </div>
    
    <div class="lb-overlay" id="leaderboardOverlay" role="dialog" aria-modal="true" aria-labelledby="lbTitle">
        <div class="lb-modal">
            <div class="lb-header">
                <h2 id="lbTitle" class="lb-title"><i class="fa-solid fa-trophy"></i> Leaderboard</h2>
                <span class="lb-sub">Supply Chain Simulation Top Scores</span>
            </div>
            <div class="lb-tablewrap">
                <table class="lb-table" id="leaderboardTable">
                    <thead>
                        <tr><th>#</th><th>Name</th><th>Score</th><th>Date</th></tr>
                    </thead>
                    <tbody id="leaderboardBody">
                        <tr><td colspan="4">Loadingâ€¦</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="lb-actions">
                <button class="lb-refresh" id="lbRefreshBtn"><i class="fa-solid fa-arrows-rotate"></i> Refresh</button>
                <button class="lb-close" id="lbCloseBtn">Close</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            window.game = {
                score: { affectedSystems: 0, financialLoss: 0, dataLeak: 0, reputation: 100 },
                state: {
                    currentSectionId: 'start',
                    synapseTechInfoGathered: false,
                    blackTyphoonTTPsAnalyzed: false,
                    legalReviewInitiated: false,
                    techScanInitiated: false,
                    supplierContacted: false,
                    malwareAnalysisComplete: false,
                    criticalModulesIsolated: false,
                    motivationAnalyzed: false,
                    synapseTechVulnerabilityAnalyzed: false, 
                    officialReportMade: false, 
                    pressConferenceHeld: false, 
                    decisionHistory: []
                },
                elements: {},
                timer: {
                    total: 300,
                    remaining: 300,
                    intervalId: null,
                    running: false
                },
                
                decisionInfo: {
                    'g1-s-bilgilendir-ust-yonetim': { 
                        title: "Prompt Senior Management Briefing", 
                        text: "Although there was no definitive proof yet, you communicated the potential threat to the CEO and CSO. This mobilized the crisis team early but also raised some questions.", 
                        strat: "Informing senior management quickly in critical security incidents is essential for proactive crisis management, but the accuracy of the information is crucial.", 
                        changes: { financialLoss: 10000, reputation: -2 }, 
                        impact: 'Neutral' 
                    },
                    'g1-s-istihbarat-dogrula': { 
                        title: "In-depth Intelligence Verification", 
                        text: "You launched a comprehensive investigation to confirm the credibility of the dark web whisper. This provided valuable information but risked wasting time.", 
                        strat: "The accuracy of intelligence is vital. However, finding the right balance between speed and accuracy in a crisis is one of the toughest decisions.", 
                        changes: { financialLoss: 5000, reputation: -1 }, 
                        clue: 'synapseTechInfoGathered', 
                        impact: 'Positive' 
                    },
                    'g1-o-teknik-tarama': {
                        title: "Urgent Technical Scan Initiated",
                        text: "You forwarded the IOCs/TTPs from the TAL report to CSO Can Demir's team and ordered an urgent scan. This aimed to quickly identify potential vulnerabilities.",
                        strat: "Early and technically focused intervention is vital to limit damage. Scans with the right IOCs can quickly reveal the scope of the attack.",
                        changes: { financialLoss: 30000, reputation: -3, affectedSystems: 5 }, 
                        clue: 'techScanInitiated',
                        impact: 'Positive'
                    },
                    'g1-o-tedarikci-iletisim': {
                        title: "Contact Established with Smart Technology",
                        text: "Contact was made with Smart Technology through Supplier Relations Manager Dr. Aylin GÃ¼neÅŸ. Your request for a joint investigation caused some discomfort with the supplier.",
                        strat: "Supplier collaboration is critical in supply chain attacks. However, managing relationships and the sensitivity of information sharing requires a careful approach.",
                        changes: { financialLoss: 15000, reputation: -7 }, 
                        clue: 'supplierContacted',
                        impact: 'Neutral'
                    },
                    'g1-o-hukuki-degerlendirme': {
                        title: "Legal Review and Communication Plan",
                        text: "You worked with Legal Counsel Zeynep Kaya on legal obligations and a crisis communication strategy. This created a solid foundation for public communication but risked delaying the technical response.",
                        strat: "While crisis communication and legal compliance are important, acting hastily before the technical investigation and response are complete can further complicate the situation.",
                        changes: { financialLoss: 25000, dataLeak: 2 }, 
                        clue: 'legalReviewInitiated',
                        impact: 'Neutral'
                    },
                    'g2-s-tersine-muhendislik': {
                        title: "Malware Reverse Engineering",
                        text: "You urgently tasked the reverse engineering team with understanding the malware's capabilities. This revealed the attacker's full capacity but the damage continued during the analysis.",
                        strat: "A deep understanding of the attack is vital for long-term defense. However, balancing swift action with comprehensive analysis is essential for managing the crisis.",
                        changes: { financialLoss: 50000, dataLeak: 5, reputation: -10 }, 
                        clue: 'malwareAnalysisComplete',
                        impact: 'Negative'
                    },
                    'g2-s-modul-yalÄ±tma': {
                        title: "Urgent Isolation of Critical Modules",
                        text: "You recommended immediately disabling or isolating the core software infrastructure for all affected customers. This stopped the attacker's spread but caused major disruptions to customer operations.",
                        strat: "Swift and radical decisions can stop immediate damage but may have significant long-term operational and financial consequences.",
                        changes: { financialLoss: 250000, affectedSystems: 20, reputation: -25 }, 
                        clue: 'criticalModulesIsolated',
                        impact: 'Negative'
                    },
                    'g2-s-motivasyon-analizi': {
                        title: "Black Typhoon Motivation Analysis",
                        text: "You analyzed the motivations and goals of the Black Typhoon group and gave a strategic briefing to the crisis team. This helped in understanding the broader context of the event but delayed the technical response.",
                        strat: "Understanding the threat actor's intent is vital for long-term defense and countermeasures. However, in an immediate crisis, the speed of the technical response is often more decisive.",
                        changes: { financialLoss: 75000, dataLeak: 10, reputation: -15 }, 
                        clue: 'motivationAnalyzed',
                        impact: 'Negative'
                    },
                    'g2-o-synapsetech-arastirma': { 
                        title: "SynapseTech Vulnerability Analysis",
                        text: "You thoroughly investigated the vulnerability in the SynapseTech library and documented the methods of exploitation. This allowed you to fully understand the root cause of the attack and provided strategic information to prevent similar attacks in the future.",
                        strat: "Root cause analysis is critical to eliminate not just the symptoms of an attack, but also the underlying security vulnerabilities.",
                        changes: { financialLoss: 100000, reputation: +10, dataLeak: -5 }, 
                        clue: 'synapseTechVulnerabilityAnalyzed', 
                        impact: 'Positive'
                    },
                    'g2-o-sucu-resmi-makamlara-bildir': {
                        title: "Official Notification to Authorities",
                        text: "You officially reported the attack to national cybersecurity units and law enforcement. This initiated the legal process and showed your company's accountability to the public, but the investigation processes increased the workload.",
                        strat: "Reporting cybercrimes to official authorities is important for legal compliance and contributing to national cybersecurity. However, this can bring additional operational and legal burdens.",
                        changes: { financialLoss: 50000, reputation: +5 }, 
                        clue: 'officialReportMade',
                        impact: 'Neutral'
                    },
                    'g2-o-daha-fazla-istihbarat': {
                        title: "Gather More Threat Intelligence",
                        text: "You investigated other supply chain attacks by the group and tried to understand their potential future targets. This provided valuable information for proactive defense but slightly slowed the response to the current incident.",
                        strat: "Continuously feeding threat intelligence is critical not only for understanding past attacks but also for predicting future threats.",
                        changes: { financialLoss: 30000, reputation: -5, dataLeak: +3 }, 
                        clue: 'moreThreatIntelGathered',
                        impact: 'Neutral'
                    },
                    'g3-s-tam-seffaflÄ±k': { 
                        title: "Full Transparency Policy",
                        text: "You explained the details of the attack, the Black Typhoon group, and the supply chain vulnerability to the public and customers in detail. This caused initial shock but increased long-term trust in your company.",
                        strat: "Full transparency in crisis communication, while risky, can build a perception of honesty, leading to long-term reputational gain and setting an industry example.",
                        changes: { financialLoss: 200000, reputation: +20, dataLeak: -5 }, 
                        impact: 'Positive'
                    },
                    'g3-s-sÄ±nÄ±rlÄ±-acÄ±klama': {
                        title: "Limited Public Statement",
                        text: "You avoided details by only stating it was a 'technical problem'. This initially prevented panic but raised suspicion among the public and failed to fully restore trust.",
                        strat: "Limited information sharing may temporarily manage the situation, but it can damage the company's perception of transparency in the long run and lead to more speculation.",
                        changes: { financialLoss: 500000, reputation: -15, dataLeak: 10 }, 
                        impact: 'Negative'
                    },
                    'g3-s-sucu-disari-atma': { 
                        title: "Blame the Supplier",
                        text: "You placed the responsibility entirely on Smart Technology. While this provided internal relief, it damaged supplier relations and left a bad impression on the public. Legal proceedings were initiated.",
                        strat: "Shifting blame may provide short-term relief, but in the long run, it poisons inter-company relationships, increases legal risks, and fundamentally erodes public trust.",
                        changes: { financialLoss: 750000, reputation: -30, affectedSystems: 10 }, 
                        impact: 'Negative'
                    },
                    'g3-o-kapsamlÄ±-guvenlik-programÄ±': {
                        title: "Comprehensive Supply Chain Security Program",
                        text: "You proposed a comprehensive program for all suppliers, including mandatory audits, SBOM, SCA, and TPRM integration. Your request for increased CTI resources was approved. The company significantly increased its cyber resilience.",
                        strat: "Establishing a strong security posture after a crisis is key to preventing future attacks and rebuilding reputation. This requires significant resources and management support but is the best long-term investment.",
                        changes: { financialLoss: 500000, reputation: +30, dataLeak: -15, affectedSystems: -10 }, 
                        impact: 'Positive'
                    },
                    'g3-o-odaklÄ±-iyilestirme': { 
                        title: "Focused Improvement and Emergency Measures",
                        text: "You focused only on fixing the vulnerabilities in the core software infrastructure. Short-term solutions were implemented, but other potential risks were ignored. The company recovered in the short term but remains vulnerable to similar attacks in the future.",
                        strat: "Focused improvement can be effective for solving immediate problems but may not offer a long-term solution against the ever-evolving nature of cybersecurity. This creates hidden risks.",
                        changes: { financialLoss: 100000, reputation: +5, dataLeak: +5, affectedSystems: +5 }, 
                        impact: 'Neutral'
                    },
                    'g3-o-degerlendirmeyi-geciktir': { 
                        title: "Delay Post-Crisis Assessment",
                        text: "Due to crisis fatigue and costs, you postponed the comprehensive assessment and investments. Although the company focused on 'returning to normal,' the risk of a similar crisis in the future increased, and reputational damage continued.",
                        strat: "Failing to learn from crises lowers a company's cybersecurity maturity and leaves it vulnerable to future risks. This is one of the worst-case scenarios.",
                        changes: { financialLoss: 1500000, reputation: -40, affectedSystems: 20, dataLeak: +15 }, 
                        impact: 'Negative'
                    }
                },

                setup() {
                    this.elements = {
                        intro: document.getElementById('introSection'), game: document.getElementById('gameContainer'), gameContent: document.getElementById('game-content'),
                        startButton: document.getElementById('startButton'), intermission: document.getElementById('intermissionSection'),
                        intermissionTitle: document.getElementById('intermissionTitle'), intermissionText: document.getElementById('intermissionText'),
                        intermissionMetrics: document.getElementById('intermissionMetrics'), strategicText: document.getElementById('strategicText'),
                        continueButton: document.getElementById('continueButton'),
                        statusBar: { 
                            affectedSystems: document.getElementById('status-affectedSystems'), 
                            financialLoss: document.getElementById('status-financialLoss'), 
                            dataLeak: document.getElementById('status-dataLeak'), 
                            reputation: document.getElementById('status-reputation'),
                            timer: document.getElementById('status-timer') ? document.getElementById('status-timer').querySelector('.value') : null
                        },
                        leaderboard: {
                            overlay: document.getElementById('leaderboardOverlay'),
                            body: document.getElementById('leaderboardBody'),
                            btnClose: document.getElementById('lbCloseBtn'),
                            btnRefresh: document.getElementById('lbRefreshBtn'),
                            btnOpen: null 
                        }
                    };
                    this.loadGameHTML();
                    this.attachListeners();
                    this.elements.intro.style.display = 'flex';
                    this.elements.game.style.display = 'none';
                },

                attachListeners() {
                    this.elements.startButton.addEventListener('click', () => {
                        this.elements.intro.style.display = 'none';
                        this.elements.game.style.display = 'block';
                        this.startGlobalTimer();
                        this.showSection('day1_morning');
                    });
                    
                    this.elements.gameContent.addEventListener('click', (e) => {
                        const button = e.target.closest('.btn[data-decision]');
                        if (!button) return;
                        
                        const decisionId = button.dataset.decision;
                        const nextSection = button.dataset.nextSection;

                        this.handleDecision(decisionId, nextSection, button);
                    });

                    this.elements.continueButton.addEventListener('click', () => {
                        const nextSectionId = this.elements.continueButton.dataset.nextSection;
                        this.elements.intermission.style.display = 'none';
                        
                        if (nextSectionId === 'finalSection') {
                             this.showFinalReport();
                        } else {
                            this.elements.game.style.display = 'block';
                            this.showSection(nextSectionId);
                        }
                    });
                    
                    this.elements.leaderboard.btnClose?.addEventListener('click', () => this.closeLeaderboard());
                    this.elements.leaderboard.btnRefresh?.addEventListener('click', () => this.loadLeaderboard());
                    this.elements.leaderboard.overlay.addEventListener('click', (e) => {
                        if (e.target === this.elements.leaderboard.overlay) this.closeLeaderboard();
                    });
                },
                
                handleDecision(decisionId, nextSectionId, button) {
                    button.closest('.decision-buttons').querySelectorAll('.btn').forEach(btn => btn.disabled = true);
                    const info = this.decisionInfo[decisionId];
                    if (!info) { console.error("Decision info not found:", decisionId); return; }

                    this.score.financialLoss += info.changes.financialLoss || 0;
                    this.score.reputation += info.changes.reputation || 0;
                    this.score.dataLeak += info.changes.dataLeak || 0;
                    this.score.affectedSystems += info.changes.affectedSystems || 0;
                    
                    if (info.clue) {
                        this.state[info.clue] = true;
                    }
                    
                    this.state.decisionHistory.push({ id: decisionId, title: info.title, text: info.text, impactType: info.impact }); 
                    this.updateState();
                    this.showIntermission(info.title, info.text, info.strat, info.changes, nextSectionId);
                },

                showIntermission(title, text, strat, changes, nextSectionId) {
                    this.elements.intermissionTitle.textContent = title;
                    this.elements.intermissionText.textContent = text;
                    this.elements.strategicText.textContent = strat;
                    
                    let metricsHTML = '';
                    const formatChange = (label, value, unit, icon, isPositive) => {
                        const arrow = value >= 0 ? 'up' : 'down';
                        const sign = value >= 0 ? '+' : ''; 
                        return `<div class="metric-change ${isPositive ? 'positive' : 'negative'}"><i class="fa-solid ${icon}"></i> ${label}: <i class="fa-solid fa-arrow-${arrow}-long"></i> ${sign}${Math.abs(value).toLocaleString('en-US')}${unit}</div>`;
                    };

                    if (changes.financialLoss) metricsHTML += formatChange('Financial Loss', changes.financialLoss, '$', 'fa-sack-xmark', false);
                    if (changes.dataLeak) metricsHTML += formatChange('Data Leak', changes.dataLeak, '%', 'fa-database', false);
                    if (changes.reputation !== undefined) metricsHTML += formatChange('Reputation Score', changes.reputation, '', 'fa-building-shield', changes.reputation > 0);
                    if (changes.affectedSystems) metricsHTML += formatChange('Affected Systems', changes.affectedSystems, '', 'fa-triangle-exclamation', false);
                    
                    if (metricsHTML === '') metricsHTML = '<p style="text-align: center; font-size: 1.1em; opacity: 0.8;">This decision had no direct impact on the metrics.</p>';

                    this.elements.intermissionMetrics.innerHTML = metricsHTML;
                    this.elements.continueButton.dataset.nextSection = nextSectionId;
                    this.elements.game.style.display = 'none';
                    this.elements.intermission.style.display = 'flex';
                },

                updateStatusBar() {
                    const s = this.score;
                    this.elements.statusBar.affectedSystems.textContent = s.affectedSystems;
                    this.elements.statusBar.financialLoss.textContent = `$${s.financialLoss.toLocaleString('en-US')}`;
                    this.elements.statusBar.dataLeak.textContent = `${s.dataLeak}%`;
                    this.elements.statusBar.reputation.textContent = Math.max(0, s.reputation);
                },

                showSection(sectionId) {
                    this.elements.sections.forEach(section => { section.style.display = 'none'; });
                    const targetSection = document.getElementById(sectionId);
                    if (targetSection) {
                        targetSection.style.display = 'block';
                        this.state.currentSectionId = sectionId;
                        this.updateDynamicContent(sectionId);
                    } else {
                        console.error('Section not found:', sectionId);
                        this.showFinalReport();
                    }
                    this.updateState();
                },
                
                showFinalReport() {
                    this.stopGlobalTimer();
                    this.elements.intro.style.display = 'none';
                    this.elements.intermission.style.display = 'none';
                    this.elements.game.style.display = 'block'; 
                    document.getElementById('statusBar').style.display = 'none';

                    this.elements.sections.forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    const finalSection = document.getElementById('finalSection');
                    if (!finalSection) { console.error("Final section not found in HTML!"); return; }

                    finalSection.style.display = 'flex';
                    finalSection.style.flexDirection = 'column';
                    finalSection.style.alignItems = 'center';
                    
                    const badge = document.getElementById('performance-badge');
                    const metricsContainer = document.getElementById('finalMetricsContainer');
                    const timelineList = document.getElementById('decision-timeline-list');
                    const debriefContent = document.getElementById('strategic-debrief-content');
                    const scoreBreakdownList = document.getElementById('score-breakdown');

                    let scoreBreakdown = {};
                    let totalScore = 35; 
                    scoreBreakdown['Starting Score'] = { value: 35, class: 'score-neutral' };

                    let decisionQualityScore = 0;
                    this.state.decisionHistory.forEach(decision => {
                        if (decision.impactType === 'Negative') {
                            decisionQualityScore -= 7;
                        } else if (decision.impactType === 'Positive') {
                            decisionQualityScore += 3;
                        }
                    });
                     if (decisionQualityScore !== 0) {
                        totalScore += decisionQualityScore;
                        scoreBreakdown['Decision Quality (Penalty/Bonus)'] = { value: decisionQualityScore, class: decisionQualityScore >= 0 ? 'score-plus' : 'score-minus' };
                    }
                    
                    const finalRep = Math.max(0, this.score.reputation);
                    let repScore = 0;
                    if (finalRep >= 90) { repScore = 20; }
                    else if (finalRep >= 70) { repScore = 10; }
                    else if (finalRep < 40) { repScore = -20; }
                    totalScore += repScore;
                    scoreBreakdown['Reputation Management'] = { value: repScore, class: repScore > 0 ? 'score-plus' : repScore < 0 ? 'score-minus' : 'score-neutral' };

                    let financialScore = 0;
                    if (this.score.financialLoss <= 500000) { financialScore = 15; }
                    else if (this.score.financialLoss <= 1000000) { financialScore = 5; }
                    else { financialScore = -20; }
                    totalScore += financialScore;
                    scoreBreakdown['Financial Management'] = { value: financialScore, class: financialScore > 0 ? 'score-plus' : financialScore < 0 ? 'score-minus' : 'score-neutral' };

                    let dataLeakScore = 0;
                    if (this.score.dataLeak <= 5) { dataLeakScore = 15; }
                    else if (this.score.dataLeak <= 15) { dataLeakScore = 0; }
                    else { dataLeakScore = -20; }
                    totalScore += dataLeakScore;
                    scoreBreakdown['Data Leak Control'] = { value: dataLeakScore, class: dataLeakScore > 0 ? 'score-plus' : dataLeakScore < 0 ? 'score-minus' : 'score-neutral' };

                    if (this.timer.remaining >= 180) {
                        totalScore += 5;
                        scoreBreakdown['Rapid Response Bonus'] = { value: 5, class: 'score-plus' };
                    }

                    totalScore = Math.round(Math.max(0, Math.min(100, totalScore))); 

                    let badgeInfo = {};
                    if (totalScore >= 90) badgeInfo = { text: 'CYBER HERO', color: 'var(--accent-green)' };
                    else if (totalScore >= 70) badgeInfo = { text: 'EXPERT STRATEGIST', color: 'var(--accent-blue)' };
                    else if (totalScore >= 40) badgeInfo = { text: 'MANAGED THE CRISIS', color: 'var(--accent-yellow)' };
                    else badgeInfo = { text: 'DISASTER', color: 'var(--accent-red)' };

                    badge.textContent = badgeInfo.text;
                    badge.style.backgroundColor = badgeInfo.color;

                    metricsContainer.innerHTML = `
                        <div class="metric-card"><div class="icon"><i class="fa-solid fa-file-invoice-dollar"></i></div><div class="label">Final Score</div><div class="value">${totalScore}/100</div></div>
                        <div class="metric-card"><div class="icon"><i class="fa-solid fa-building-shield"></i></div><div class="label">Reputation Score</div><div class="value">${finalRep}/100</div></div>
                        <div class="metric-card"><div class="icon"><i class="fa-solid fa-hand-holding-dollar"></i></div><div class="label">Financial Loss</div><div class="value">$${this.score.financialLoss.toLocaleString('en-US')}</div></div>
                        <div class="metric-card"><div class="icon"><i class="fa-solid fa-database"></i></div><div class="label">Data Leak</div><div class="value">${this.score.dataLeak}%</div></div>
                        <div class="metric-card"><div class="icon"><i class="fa-solid fa-triangle-exclamation"></i></div><div class="label">Affected Systems</div><div class="value">${this.score.affectedSystems}</div></div>
                    `;

                    timelineList.innerHTML = this.state.decisionHistory.map(decision => {
                        let liClass = decision.impactType.toLowerCase();
                        return `<li class="${liClass}"><span class="decision-title">${decision.title}</span></li>`;
                    }).join('');
                    
                    scoreBreakdownList.innerHTML = Object.entries(scoreBreakdown).map(([key, item]) => {
                        const sign = item.value >= 0 ? '+' : '';
                        return `<li class="${item.class}"><span>${key}</span><span class="score-value">${sign}${item.value} Points</span></li>`;
                    }).join('');

                    let debriefHTML = '';
                    if (badgeInfo.text === 'CYBER HERO' || badgeInfo.text === 'EXPERT STRATEGIST') { 
                        debriefHTML += `<p><strong>Leadership in Crisis Management:</strong> Thanks to your swift, accurate, and transparent decisions, COLHAK Technology emerged from this global supply chain crisis with minimal damage. Your CTI expertise allowed us to understand the attacker's motivations and methods early on. Our reputation has been strengthened, and we have set an example in the industry.</p>`;
                    } else if (badgeInfo.text === 'MANAGED THE CRISIS') { 
                        debriefHTML += `<p><strong>A Tough Challenge:</strong> You were successful in managing the crisis, but some decisions had long-term consequences. With the lessons learned, we must further strengthen our future security posture. CTI activities provided critical information, but we could have acted faster at some points.</p>`;
                    } else { 
                        debriefHTML += `<p><strong>Serious Consequences:</strong> Some decisions made during the crisis management process increased the company's financial losses and severely damaged its reputation. The data leak and system outages have shaken customer confidence. We must urgently learn from this experience and fundamentally change our security strategies.</p>`;
                    }
                    debriefContent.innerHTML = debriefHTML;
                    
                    this.saveLeaderboard(totalScore);
                },

                updateState() { this.updateStatusBar(); this.updateSlackChat(this.state.currentSectionId); },

                updateSlackChat(currentSection) {
                    const sectionElement = document.getElementById(currentSection);
                    if (!sectionElement) return;
                    const chatViewer = sectionElement.querySelector('.slack-chat');
                    if (!chatViewer) return; 

                    let chat = '';
                    if (currentSection === 'day2_morning' || currentSection === 'day2_afternoon_investigation') {
                        chat = `
                            <div class="message"><span class="sender ceo">CEO Elara YÄ±lmaz:</span> I'm following the situation closely. Our stocks are down, I expect a quick solution!</div>
                            <div class="message"><span class="sender legal">Legal Counsel Zeynep Kaya:</span> We must carefully assess our legal responsibilities. Hasty statements could cause problems later.</div>
                            <div class="message"><span class="sender ops">Operations Dir. Levent AkÄ±n:</span> We are receiving a high volume of complaints from our customers. When will the systems be back to normal? Our business continuity is at risk!</div>
                            <div class="message"><span class="sender cso">CSO Can Demir:</span> Our teams are working 24/7. The information from CTI is vital for us to take the right steps.</div>
                            <div class="message"><span class="sender">You (CTI Specialist):</span> We are analyzing the available data quickly. Understanding Black Typhoon's TTPs is critical for countermeasures.</div>
                        `;
                    } else if (currentSection === 'day3_morning_communication' || currentSection === 'day3_afternoon_strategy') { 
                        chat = `
                            <div class="message"><span class="sender ceo">CEO Elara YÄ±lmaz:</span> We've weathered the initial shock. What are our plans for the future? How will we learn from this crisis?</div>
                            <div class="message"><span class="sender ops">Operations Dir. Levent AkÄ±n:</span> We need concrete steps to regain customer trust. Compensating for the outages is important.</div>
                            <div class="message"><span class="sender legal">Legal Counsel Zeynep Kaya:</span> This incident shows that the security clauses in our contracts need to be reviewed.</div>
                            <div class="message"><span class="sender cso">CSO Can Demir:</span> We must further strengthen our defense mechanisms. The role of the CTI team will be key in this process.</div>
                            <div class="message"><span class="sender">You (CTI Specialist):</span> The root cause analysis is shedding light on how to prevent future attacks. The intelligence we've gathered is invaluable.</div>
                        `;
                    }
                    chatViewer.innerHTML = chat;
                },
                updateDynamicContent(sectionId) {},
                
                loadGameHTML() {
                    const gameHTMLContent = `
                        <div id="day1_morning" class="section">
                            <h2><i class="fa-solid fa-hourglass-start"></i> Day 1: First Signals and Whispers</h2>
                            <h3>08:30 AM - Coffee and a Bad Feeling</h3>
                            <p>While going through your morning routine, you notice a sudden burst of activity on one of your private CTI channels. On a dark web forum that usually shares breach intelligence, an encrypted post about one of COLHAK's critical suppliers, <strong>Smart Technology</strong>, has appeared. Smart Technology provides <strong>core software infrastructure</strong> to COLHAK.</p>
                            <p>The post contains vague but alarming hints that the core software infrastructure might have a "secret door". There's no proof yet, just a whisper.</p>
                            <img src="images/darkweb_forum.png" alt="Encrypted post on a Dark Web forum" class="scenario-image">
                            <div class="interactive-element">
                                <h4>As a CTI Specialist, what is your first step?</h4>
                                <div class="decision-buttons">
                                    <button class="btn" data-decision="g1-s-bilgilendir-ust-yonetim" data-next-section="day1_afternoon"><i class="fa-solid fa-share-nodes"></i><div class="btn-text">Option A: Immediately Inform CEO Elara YÄ±lmaz and CSO Can Demir.<small>Take a proactive approach by reporting the situation to top management right away.</small></div></button>
                                    <button class="btn" data-decision="g1-s-istihbarat-dogrula" data-next-section="day1_afternoon"><i class="fa-solid fa-magnifying-glass"></i><div class="btn-text">Option B: First, Verify Your Intelligence and Gather More Information from Reliable Sources.<small>Conduct more research to confirm the credibility of the dark web post.</small></div></button>
                                </div>
                            </div>
                            <div class="learning-note"><strong>Learning Note:</strong> The first moments of a cyber crisis are crucial. Your initial reaction can significantly influence the course of the crisis. Balancing information sharing and verification is important.</div>
                        </div>

                        <div id="day1_afternoon" class="section">
                            <h2><i class="fa-solid fa-bell"></i> Day 1: Afternoon - Unconfirmed Suspicions</h2>
                            <h3>03:00 PM - Industry Alert</h3>
                            <p>A leading cybersecurity research firm, "Threat Analysis Lab" (TAL), has issued an alert about a new vector used by the "Black Typhoon" group in supply chain attacks. The alert specifically mentions infiltration of software signing processes and the surreptitious addition of malicious code to legitimate software. There's no mention of COLHAK or Smart Technology yet, but there are striking similarities to the technical details of the core software infrastructure.</p>
                            <img src="images/sector_alert.png" alt="Industry alert screenshot" class="scenario-image">
                            <div class="interactive-element">
                                <h4>As a CTI Specialist, what step will you take?</h4>
                                <div class="decision-buttons">
                                    <button class="btn" data-decision="g1-o-teknik-tarama" data-next-section="day2_morning"><i class="fa-solid fa-bug-slash"></i><div class="btn-text">Option A: Provide a Detailed IOC/TTP List to CSO Can Demir's Team and Request an Urgent Technical Scan.<small>Direct the technical team to quickly identify potential vulnerabilities.</small></div></button>
                                    <button class="btn" data-decision="g1-o-tedarikci-iletisim" data-next-section="day2_morning"><i class="fa-solid fa-handshake"></i><div class="btn-text">Option B: Immediately Contact Smart Technology through Supplier Relations Manager Dr. Aylin GÃ¼neÅŸ.<small>Get in touch with the supplier to initiate a joint investigation.</small></div></button>
                                    <button class="btn" data-decision="g1-o-hukuki-degerlendirme" data-next-section="day2_morning"><i class="fa-solid fa-gavel"></i><div class="btn-text">Option C: Request a Legal Assessment from Legal Counsel Zeynep Kaya and Prepare a Crisis Communication Plan.<small>Evaluate potential legal liabilities and the public statement.</small></div></button>
                                </div>
                            </div>
                            <div class="learning-note"><strong>Learning Note:</strong> Proper prioritization in a crisis is vital for the efficient use of resources. You must strike a good balance between technical response, collaboration, and legal preparation.</div>
                        </div>

                        <div id="day2_morning" class="section">
                            <h2><i class="fa-solid fa-burst"></i> Day 2: The Crisis Erupts</h2>
                            <h3>09:30 AM - The Disaster Scenario Unfolds!</h3>
                            <p>Several critical COLHAK customers (a major financial institution and an energy distribution network) have started reporting abnormal behavior in their authentication systems following the latest update to the core software infrastructure. Random user account lockouts, unauthorized access attempts, and unexpected log activities are being detected.</p>
                            <p>You receive a panicked call from CSO Can Demir: <em>"In the telemetry data from Smart Technology's core software infrastructure, we found signatures matching the software signing anomalies you mentioned. I think <strong>Black Typhoon is inside!</strong>"</em></p>
                            <img src="images/crisis_desk.png" alt="Emergency crisis desk" class="scenario-image">
                            <div class="interactive-element">
                                <h4>What urgent CTI-based recommendation do you give to the crisis team?</h4>
                                <div class="slack-chat" id="slackChat"></div>
                                <div class="decision-buttons">
                                    <button class="btn" data-decision="g2-s-tersine-muhendislik" data-next-section="day2_afternoon_investigation"><i class="fa-solid fa-code-branch"></i><div class="btn-text">Option A: Immediately Send the Malicious Software to the Reverse Engineering Team.<small>Conduct a detailed analysis to fully understand the scope and potential impact of the attack.</small></div></button>
                                    <button class="btn" data-decision="g2-s-modul-yalÄ±tma" data-next-section="day2_afternoon_investigation"><i class="fa-solid fa-unlink"></i><div class="btn-text">Option B: Recommend Immediately Disabling or Isolating the Core Software Infrastructure for All Affected Customers.<small>Take radical and swift action to stop the spread of the attack.</small></div></button>
                                    <button class="btn" data-decision="g2-s-motivasyon-analizi" data-next-section="day2_afternoon_investigation"><i class="fa-solid fa-chart-network"></i><div class="btn-text">Option C: Analyze the Motivations and Goals of the Black Typhoon Group and Give an Intelligence Briefing to the Crisis Team.<small>Reveal the intent and long-term goals behind the attack.</small></div></button>
                                </div>
                            </div>
                            <div class="learning-note"><strong>Learning Note:</strong> Once an attack is confirmed, speed and the right response are critical. Your decisions will have both technical and operational consequences.</div>
                        </div>

                        <div id="day2_afternoon_investigation" class="section">
                            <h2><i class="fa-solid fa-magnifying-glass-chart"></i> Day 2: Afternoon - In-depth Investigation and Root Cause Analysis</h2>
                            <h3>02:00 PM - A Look Inside the Black Box</h3>
                            <p>The first findings on how Black Typhoon infiltrated Smart Technology's software are beginning to emerge. Initial reverse engineering analysis shows that the malicious code is not just a backdoor, but also targets a specific supply chain component: <strong>one of SynapseTech's open-source libraries.</strong> This library is part of Smart Technology's core software infrastructure.</p>
                            <p>Additionally, new encrypted messages related to "SynapseTech" and "supply chain vulnerability" have started circulating in your dark web intelligence channels. These messages may indicate that other cybercrime groups are also trying to exploit this vulnerability for their own purposes.</p>
                            <img src="images/synapse_tech_analysis.png" alt="SynapseTech analysis visual" class="scenario-image">
                            <div class="interactive-element">
                                <h4>As a CTI Specialist, what is your next critical step?</h4>
                                <div class="decision-buttons">
                                    <button class="btn" data-decision="g2-o-synapsetech-arastirma" data-next-section="day3_morning_communication"><i class="fa-solid fa-search"></i><div class="btn-text">Option A: Thoroughly Investigate the Vulnerability in the SynapseTech Library and Document Its Exploitation Methods.<small>This will help you understand the attacker's exact entry vector and prevent similar attacks.</small></div></button>
                                    <button class="btn" data-decision="g2-o-sucu-resmi-makamlara-bildir" data-next-section="day3_morning_communication"><i class="fa-solid fa-building-columns"></i><div class="btn-text">Option B: Make an Official Notification to National Cybersecurity Units (CERT/CSIRT) and Law Enforcement.<small>Initiate the legal process and official investigation, emphasizing that the attack could affect national security.</small></div></button>
                                    <button class="btn" data-decision="g2-o-daha-fazla-istihbarat" data-next-section="day3_morning_communication"><i class="fa-solid fa-eye"></i><div class="btn-text">Option C: Gather More Threat Intelligence on Black Typhoon.<small>Focus on understanding the potential for the attack to spread to other supply chain components or other targets.</small></div></button>
                                </div>
                            </div>
                            <div class="learning-note"><strong>Learning Note:</strong> Root cause analysis is critical for preventing future attacks. At the same time, the steps you take in the legal and public relations dimensions will affect the overall perception of the crisis.</div>
                        </div>

                        <div id="day3_morning_communication" class="section">
                            <h2><i class="fa-solid fa-bullhorn"></i> Day 3: Morning - Damage Control and Communication</h2>
                            <h3>09:30 AM - Running Out of Time</h3>
                            <p>Due to the backdoor in the core software infrastructure and the SynapseTech vulnerability, it's confirmed that Black Typhoon has deeply infiltrated your customers' networks and data breaches have occurred. The news is spreading like wildfire in the media: <strong>"Crisis Deepens Between COLHAK Technology and Its Supplier!"</strong> The public expects a clear statement from your company.</p>
                            <img src="images/press_conference.png" alt="Press conference visual" class="scenario-image">
                            <div class="interactive-element">
                                <h4>How will you make a statement to the public and stakeholders?</h4>
                                <div class="decision-buttons">
                                    <button class="btn" data-decision="g3-s-tam-seffaflÄ±k" data-next-section="day3_afternoon_strategy"><i class="fa-solid fa-check-double"></i><div class="btn-text">Option A: Full Transparency.<small>Explain the incident in full detail, including the cause of the leak, the Black Typhoon group, and the supply chain vulnerability.</small></div></button>
                                    <button class="btn" data-decision="g3-s-sÄ±nÄ±rlÄ±-acÄ±klama" data-next-section="day3_afternoon_strategy"><i class="fa-solid fa-file-contract"></i><div class="btn-text">Option B: Limited Disclosure.<small>State only that there was a 'technical problem,' avoid details, and say the investigation is ongoing.</small></div></button>
                                    <button class="btn" data-decision="g3-s-sucu-disari-atma" data-next-section="day3_afternoon_strategy"><i class="fa-solid fa-mask"></i><div class="btn-text">Option C: Shift the Blame.<small>Claim that the attack was entirely the responsibility of the supplier, Smart Technology, and that COLHAK is a victim.</small></div></button>
                                </div>
                            </div>
                            <div class="learning-note"><strong>Learning Note:</strong> Crisis communication is the backbone of reputation management. You must strike a delicate balance between transparency, trust, responsibility, and legal obligations.</div>
                        </div>

                        <div id="day3_afternoon_strategy" class="section">
                            <h2><i class="fa-solid fa-shield-alt"></i> Day 3: Afternoon - Long-Term Strategy and Recovery</h2>
                            <h3>02:00 PM - Time to Heal the Wounds</h3>
                            <p>The causes and scope of the attack are now largely clear. You need to make important decisions for your company's future cyber resilience. CEO Elara YÄ±lmaz and CSO Can Demir state that internal security protocols and supplier audits need to be urgently reviewed. Legal Counsel Zeynep Kaya is working on legal defense strategies against potential lawsuits. Financial losses continue to mount.</p>
                            <img src="images/recovery_efforts.png" alt="Recovery and healing efforts visual" class="scenario-image">
                            <div class="interactive-element">
                                <h4>What long-term strategy will you recommend for your company's future cyber resilience?</h4>
                                <div class="decision-buttons">
                                    <button class="btn" data-decision="g3-o-kapsamlÄ±-guvenlik-programÄ±" data-next-section="finalSection"><i class="fa-solid fa-lock"></i><div class="btn-text">Option A: Launch a Comprehensive Supply Chain Security Program.<small>Require mandatory audits, SBOM (Software Bill of Materials), and SCA (Software Composition Analysis) integration for all suppliers. Increase CTI resources.</small></div></button>
                                    <button class="btn" data-decision="g3-o-odaklÄ±-iyilestirme" data-next-section="finalSection"><i class="fa-solid fa-screwdriver-wrench"></i><div class="btn-text">Option B: Fix Only the Vulnerabilities in the Core Software Infrastructure and Apply an Emergency Patch.<small>Quickly resolve the most critical issues, but postpone broader supply chain security concerns.</small></div></button>
                                    <button class="btn" data-decision="g3-o-degerlendirmeyi-geciktir" data-next-section="finalSection"><i class="fa-solid fa-clock-rotate-left"></i><div class="btn-text">Option C: Delay the Post-Crisis Comprehensive Assessment and Investments.<small>Focus on stabilizing the situation, citing budget constraints and staff fatigue, and postpone long-term plans.</small></div></button>
                                </div>
                            </div>
                            <div class="learning-note"><strong>Learning Note:</strong> The long-term decisions made after a crisis determine not only the company's short-term recovery but also its future resilience and reputation.</div>
                        </div>

                        <div id="finalSection" class="section centered-page" style="display: none;">
                            <h2><i class="fa-solid fa-chart-line"></i> Post-Crisis Evaluation Report</h2>
                            <p>The simulation is complete. Below is a detailed breakdown of your crisis management performance.</p>
                            <div id="performance-badge-container"><span id="performance-badge"></span></div>
                            <div class="final-metrics" id="finalMetricsContainer"></div>
                            <div class="post-crisis-layout">
                                <div class="event-timeline">
                                    <h3><i class="fa-solid fa-timeline"></i> Decision Timeline</h3>
                                    <ul id="decision-timeline-list"></ul>
                                </div>
                                <div class="strategic-debrief">
                                    <h3><i class="fa-solid fa-lightbulb"></i> Strategic Debrief</h3>
                                    <div id="strategic-debrief-content"></div>
                                    <h3 style="margin-top: 20px;"><i class="fa-solid fa-calculator"></i> Score Breakdown</h3>
                                    <ul id="score-breakdown"></ul>
                                </div>
                            </div>
                            <div class="decision-buttons" style="margin-top: 40px; display:flex; gap:12px; flex-wrap:wrap; justify-content:center;">
                                <button class="btn btn-start" onclick="location.reload()"><i class="fa-solid fa-arrow-rotate-right"></i> Restart Simulation</button>
                                <button class="btn" id="openLeaderboardBtn"><i class="fa-solid fa-trophy"></i> Leaderboard</button>
                            </div>
                        </div>
                    `;
                    this.elements.gameContent.innerHTML = gameHTMLContent;
                    this.elements.sections = this.elements.gameContent.querySelectorAll('.section');
                    this.elements.leaderboard.btnOpen = document.getElementById('openLeaderboardBtn');
                    this.elements.leaderboard.btnOpen?.addEventListener('click', () => this.openLeaderboard());
                    hljs.highlightAll();
                },
                
                startGlobalTimer() {
                    if (this.timer.running) return;
                    this.timer.running = true;
                    this.timer.remaining = this.timer.total;
                    this.updateTimerUI();
                    this.timer.intervalId = setInterval(() => {
                        this.timer.remaining--;
                        this.updateTimerUI();
                        if (this.timer.remaining <= 0) {
                            this.stopGlobalTimer();
                            alert("Time's up! Generating report.");
                            this.showFinalReport();
                        }
                    }, 1000);
                },

                stopGlobalTimer() {
                    if (this.timer.intervalId) clearInterval(this.timer.intervalId);
                    this.timer.intervalId = null;
                    this.timer.running = false;
                },

                updateTimerUI() {
                    const m = String(Math.floor(this.timer.remaining / 60)).padStart(2,'0');
                    const s = String(this.timer.remaining % 60).padStart(2,'0');
                    if (this.elements.statusBar.timer) {
                        this.elements.statusBar.timer.textContent = `${m}:${s}`;
                    }
                },

                openLeaderboard() {
                    this.elements.leaderboard.overlay.style.display = 'flex';
                    this.loadLeaderboard();
                },

                closeLeaderboard() {
                    this.elements.leaderboard.overlay.style.display = 'none';
                },

                async saveLeaderboard(finalScore) {
                    let name = localStorage.getItem('playerName');
                    if (!name || name.trim() === '') {
                        name = prompt("Enter your name for the leaderboard:", "Anonymous");
                        if (!name || name.trim() === '') name = 'Anonymous';
                        localStorage.setItem('playerName', name);
                    }
                    
                    const payload = {
                        scenario: 'v4-supplychain',
                        name: name.toString().slice(0, 40),
                        score: finalScore,
                        details: this.score,
                        timeSpentSec: this.timer.total - this.timer.remaining,
                        timestamp: new Date().toISOString()
                    };

                    try {
                        const res = await fetch('/api/score', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!res.ok) throw new Error('API request failed');
                    } catch(e) {
                        console.warn("Could not reach API. Saving score locally.");
                        const key = 'leaderboard-v4-supplychain';
                        const arr = JSON.parse(localStorage.getItem(key) || '[]');
                        arr.push(payload);
                        arr.sort((a,b)=> b.score - a.score);
                        localStorage.setItem(key, JSON.stringify(arr.slice(0,100)));
                    }
                },

                async loadLeaderboard() {
                    const tbody = this.elements.leaderboard.body;
                    const key = 'leaderboard-v4-supplychain';
                    tbody.innerHTML = `<tr><td colspan="4">Loadingâ€¦</td></tr>`;
                    let rows = [];
                    try {
                        const res = await fetch('/api/leaderboard?scenario=v4-supplychain');
                        if (!res.ok) throw new Error('API request failed');
                        const data = await res.json();
                        rows = Array.isArray(data) ? data : [];
                    } catch(e) {
                        console.warn("Could not reach API. Loading leaderboard from local storage.");
                        const arr = JSON.parse(localStorage.getItem(key) || '[]');
                        rows = arr.map(x => ({ name: x.name, score: x.score, timestamp: x.timestamp }));
                    }

                    if (!rows.length) {
                        tbody.innerHTML = `<tr><td colspan="4">No entries yet.</td></tr>`;
                        return;
                    }
                    
                    rows.sort((a,b)=> b.score - a.score);
                    tbody.innerHTML = rows.slice(0,50).map((r,i)=>`
                        <tr>
                            <td>${i+1}</td>
                            <td>${(r.name || 'Anonymous').toString().slice(0,40)}</td>
                            <td>${r.score}</td>
                            <td>${r.timestamp ? new Date(r.timestamp).toLocaleString('en-US') : '-'}</td>
                        </tr>
                    `).join('');
                }
            };
            window.game.setup();
        });
    </script>
</body>
</html>
