<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberScenario v5: Phishing Crisis Simulation</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/dracula.min.css">
    <style>
        :root {
            --dark-bg: #1a1a2e;
            --container-bg: #2a2a4a;
            --section-bg: #333355;
            --interactive-bg: #444466;
            --accent-blue: #8be9fd;
            --accent-purple: #bd93f9;
            --accent-pink: #ff79c6;
            --accent-green: #50fa7b;
            --accent-yellow: #f1fa8c;
            --accent-red: #ff5555;
            --text-light: #e0e0e0;
            --text-dark: #282a36;
            --shadow-light: rgba(0, 0, 0, 0.2);
            --shadow-dark: rgba(0, 0, 0, 0.5);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-light);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            line-height: 1.7;
            font-size:0.90em;
        }

        .container {
            background-color: var(--container-bg);
            border-radius: 12px;
            box-shadow: 0 10px 30px var(--shadow-dark);
            padding: 20px;
            max-width: 950px;
            width: 100%;
            margin: 40px 0;
            animation: fadeIn 0.8s ease-out;
        }

        @media (min-width: 768px) {
            .container { padding: 40px; }
        }

        .centered-page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            min-height: 60vh;
        }

        h1 {
            font-size: 2.4em;
            color: var(--accent-blue);
            margin-bottom: 25px;
            text-shadow: 2px 2px 5px var(--shadow-dark);
        }

        h2 {
            font-size: 1.9em;
            color: var(--accent-blue);
            border-bottom: 2px solid var(--interactive-bg);
            padding-bottom: 15px;
            margin-bottom: 30px;
            text-align: left;
        }

        h3 {
            font-size: 1.5em;
            color: var(--accent-purple);
            margin-top: 25px;
            margin-bottom: 15px;
            text-align: left;
        }

        h4 {
            font-size: 1.1em;
            color: var(--accent-yellow);
            text-align: left;
            margin-top: 0;
            border-bottom: 1px solid var(--interactive-bg);
            padding-bottom: 10px;
        }

        p {
            font-size: 1em;
            margin-bottom: 15px;
        }

        .section {
            display: none;
            padding: 20px;
            background-color: var(--section-bg);
            border-radius: 8px;
            margin-top: 25px;
            animation: fadeIn 0.7s ease-out;
        }

        @media (min-width: 768px) {
            .section { padding: 30px; }
        }

        .interactive-element {
            background-color: var(--interactive-bg);
            border-radius: 8px;
            padding: 25px;
            margin-top: 30px;
            box-shadow: 0 5px 15px var(--shadow-light);
        }

        .decision-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 25px;
        }

        .btn {
            background-color: #6272a4;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 700;
            box-shadow: 0 2px 8px var(--shadow-light);
        }

        .btn:hover {
            background-color: #7a8ab9;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px var(--shadow-dark);
        }

        .btn:disabled {
            background-color: #555 !important;
            color: #999 !important;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }

        .btn .btn-text {
            flex-grow: 1;
        }

        .btn small {
            display: block;
            font-size: 0.85em;
            opacity: 0.8;
            margin-top: 5px;
            font-weight: 400;
            color: var(--accent-blue);
        }

        .btn-start, .btn-continue {
            font-size: 1.3em;
            font-weight: bold;
            text-align: center;
            background-color: var(--accent-green);
            color: var(--text-dark);
            justify-content: center;
            margin-top: 40px;
            padding: 18px 30px;
        }

        .btn.critical {
            background-color: var(--accent-pink);
        }

        .btn.critical:hover {
            background-color: #ff6e87;
        }

        #intermissionSection .metric-change-summary-container {
            background-color: var(--section-bg);
            border-radius: 8px;
            padding: 25px;
            margin-top: 0; /* Adjusted for direct placement after h2 */
            box-shadow: 0 5px 15px var(--shadow-light);
            width: 100%;
            max-width: 600px;
        }

        #intermissionSection .metric-change-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        #intermissionSection .metric-change {
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 5px;
            background-color: var(--interactive-bg); /* Use interactive-bg for metric changes within summary */
            box-shadow: inset 0 1px 5px rgba(0,0,0,0.2);
            justify-content: center;
        }

        .metric-change .positive { color: var(--accent-green); }
        .metric-change .negative { color: var(--accent-red); }
        .metric-change .neutral { color: var(--accent-blue); }

        /* Start Section New Styles */
        .intro-info-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-top: 30px;
            width: 100%;
            max-width: 800px;
            text-align: left;
        }

        @media (min-width: 768px) {
            .intro-info-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .intro-roles-container, .intro-metrics-container {
            background-color: var(--section-bg);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px var(--shadow-light);
            border: 1px solid var(--interactive-bg);
        }

        .intro-roles-container h3, .intro-metrics-container h3 {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--interactive-bg);
            color: var(--accent-purple);
            text-align: center;
        }

        .intro-roles-container ul, .intro-metrics-container ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .intro-roles-container li, .intro-metrics-container li {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 1px dashed var(--interactive-bg);
            font-size: 1.05em;
        }

        .intro-roles-container li:last-child, .intro-metrics-container li:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .intro-roles-container li .icon, .intro-metrics-container li .icon {
            font-size: 1.8em;
            color: var(--accent-blue);
            flex-shrink: 0;
            width: 35px;
            text-align: center;
        }
        
        .intro-roles-container li strong {
            color: var(--accent-yellow);
        }

        .intro-roles-container li small {
            display: block;
            font-size: 0.9em;
            color: var(--text-light);
            opacity: 0.8;
            margin-top: 3px;
        }
        /* End Start Section New Styles */

        #statusBar {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
            background-color: var(--text-dark);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid #6272a4;
            box-shadow: 0 4px 12px var(--shadow-dark);
        }

        #statusBar .metric {
            text-align: center;
            font-size: 0.9em;
            flex: 1;
            min-width: 100px;
        }

        #statusBar .metric .value {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--accent-yellow);
            margin-top: 5px;
        }

        .final-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-top: 30px;
            width: 100%;
            max-width: 850px;
        }

        .metric-card {
            background-color: var(--section-bg);
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--interactive-bg);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px var(--shadow-light);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 160px;
        }

        .metric-card:hover {
            transform: scale(1.03);
            border-color: var(--accent-blue);
            box-shadow: 0 6px 20px var(--shadow-dark);
        }

        .metric-card .icon {
            font-size: 2.8em;
            color: var(--accent-blue);
            margin-bottom: 12px;
        }

        .metric-card .label {
            font-size: 1.1em;
            margin-bottom: 8px;
            color: var(--text-light);
        }

        .metric-card .value {
            font-size: 2em;
            font-weight: bold;
            color: var(--accent-yellow);
        }

        .code-block, .slack-chat {
            background-color: var(--text-dark);
            border: 1px solid #6272a4;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            white-space: pre-wrap;
            word-break: break-all;
            font-family: 'Consolas', monospace;
            font-size: 0.95em;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.3);
        }

        .learning-note {
            background-color: var(--text-dark);
            border-left: 5px solid var(--accent-blue);
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            font-style: italic;
            opacity: 0.9;
        }

        .scenario-image {
            width: 100%;
            max-width: 600px;
            margin: 25px auto;
            display: block;
            border-radius: 8px;
            border: 1px solid var(--interactive-bg);
            box-shadow: 0 4px 15px var(--shadow-dark);
        }

        .slack-chat .message {
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 7px;
            background-color: #3f3f5a;
            border: 1px solid #555577;
            animation: fadeIn 0.5s ease-out;
        }

        .slack-chat .sender {
            font-weight: bold;
            color: var(--accent-pink);
            margin-right: 8px;
        }

        .slack-chat .sender.cso { color: var(--accent-green); }
        .slack-chat .sender.ops { color: var(--accent-yellow); }
        .slack-chat .sender.hr { color: var(--accent-blue); }
        .slack-chat .sender.finance { color: var(--accent-red); }
        .slack-chat .sender.ceo { color: var(--accent-purple); }
        .slack-chat .sender.bt { color: var(--accent-blue); }

        .suspect-card {
            background-color: var(--interactive-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 5px solid var(--accent-purple);
            box-shadow: 0 2px 8px var(--shadow-light);
        }

        .suspect-card h4 {
            margin-top: 0;
            margin-bottom: 5px;
            border-bottom: none;
            color: var(--accent-purple);
        }

        /* Final Section specific styles */
        #finalSection {
            text-align: center;
        }

        #performance-badge-container {
            margin: 25px 0;
        }

        #performance-badge {
            padding: 15px 35px;
            font-size: 2em;
            font-weight: bold;
            border-radius: 50px;
            display: inline-block;
            color: var(--text-dark);
            box-shadow: 0 5px 20px var(--shadow-dark);
            transition: transform 0.3s ease;
        }

        #performance-badge:hover {
            transform: scale(1.08);
        }

        .post-crisis-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            text-align: left;
            margin-top: 40px;
            width: 100%;
        }

        @media (min-width: 800px) {
            .post-crisis-layout {
                grid-template-columns: 1fr 1fr;
            }
        }

        .event-timeline, .strategic-debrief {
            background-color: var(--interactive-bg);
            padding: 25px;
            border-radius: 8px;
            border: 1px solid var(--section-bg);
            margin-top: 20px;
            box-shadow: 0 4px 15px var(--shadow-light);
        }

        .event-timeline h3, .strategic-debrief h3 {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--section-bg);
            color: var(--accent-blue);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .event-timeline ul {
            list-style-type: none;
            padding-left: 0;
            margin: 15px 0 0 0;
        }

        .event-timeline li {
            position: relative;
            padding: 5px 0 15px 35px;
            border-left: 2px solid var(--section-bg);
            font-size: 0.95em;
        }

        .event-timeline li:last-child {
            border-left: none;
        }

        .event-timeline li::before {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: var(--accent-green);
            position: absolute;
            left: -12px;
            top: 5px;
            background-color: var(--dark-bg);
            width: 22px;
            height: 22px;
            border-radius: 50%;
            text-align: center;
            line-height: 22px;
            font-size: 0.8em;
            border: 2px solid var(--section-bg);
        }

        .event-timeline li.negative::before { content: '\f00d'; color: var(--accent-red); }
        .event-timeline li.neutral::before { content: '\f05a'; color: var(--accent-blue); }

        .event-timeline li .decision-title {
            font-weight: bold;
            color: var(--accent-purple);
            display: block;
            margin-bottom: 4px;
        }

        .event-timeline li .decision-impact {
            font-style: italic;
            opacity: 0.8;
            font-size: 0.9em;
        }

        #strategic-debrief-content p {
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        /* YENİ EKLENEN STİLLER */
        #score-breakdown { list-style: none; padding: 0; margin-top: 15px; text-align: left; }
        #score-breakdown li { padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; font-size: 1.05em; display: flex; justify-content: space-between; }
        #score-breakdown .score-plus { background-color: rgba(80, 250, 123, 0.1); border-left: 3px solid var(--accent-green); }
        #score-breakdown .score-minus { background-color: rgba(255, 85, 85, 0.1); border-left: 3px solid var(--accent-red); }
        #score-breakdown .score-neutral { background-color: rgba(139, 233, 253, 0.1); border-left: 3px solid var(--accent-blue); }
        #score-breakdown .score-value { font-weight: bold; }

        .lb-overlay{
            display:none; position:fixed; inset:0;
            background: rgba(10,10,25,.7);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
            z-index:9999; align-items:center; justify-content:center; padding:20px;
            animation: fadeIn 0.3s ease-out;
        }
        .lb-modal{
            background: linear-gradient(180deg, #2a2a4a 0%, #1f1f36 100%);
            color: var(--text-light);
            width:100%; max-width: 760px; border-radius:14px; padding:22px 22px 16px;
            border:1px solid rgba(255,255,255,.08);
            box-shadow: 0 18px 50px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.04);
        }
        .lb-header{
            display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;
        }
        .lb-title{
            display:flex; align-items:center; gap:10px;
            font-size:1.25em; font-weight:800; letter-spacing:.2px; color: var(--accent-yellow);
        }
        .lb-title i{ filter: drop-shadow(0 2px 6px rgba(0,0,0,.35)); }
        .lb-tablewrap{
            margin-top:10px;
            max-height: 60vh; overflow:auto;
            border:1px solid var(--interactive-bg); border-radius:10px;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
        }
        table.lb-table{ width:100%; border-collapse:collapse; font-size:.97em; }
        table.lb-table th, table.lb-table td{ padding:10px 12px; text-align:left; }
        table.lb-table thead th{
            position: sticky; top:0; z-index:1;
            background:#1f1f36; color:#e9e9ff;
            border-bottom: 1px solid #3b3b66;
            font-weight:700; letter-spacing:.3px;
        }
        table.lb-table tbody td{ border-bottom:1px solid rgba(255,255,255,.06); color:#e9e9f5; }
        table.lb-table tbody tr:hover{ background-color: rgba(255,255,255,.045); }
        table.lb-table tbody tr:nth-child(1){ background: linear-gradient(90deg, rgba(255,215,0,.18), transparent 65%); }
        table.lb-table tbody tr:nth-child(1) td:first-child::after{ content:" 🥇"; }
        table.lb-table tbody tr:nth-child(2){ background: linear-gradient(90deg, rgba(192,192,192,.18), transparent 65%); }
        table.lb-table tbody tr:nth-child(2) td:first-child::after{ content:" 🥈"; }
        table.lb-table tbody tr:nth-child(3){ background: linear-gradient(90deg, rgba(205,127,50,.18), transparent 65%); }
        table.lb-table tbody tr:nth-child(3) td:first-child::after{ content:" 🥉"; }
        .lb-actions{ display:flex; gap:12px; justify-content:flex-end; margin-top:14px; }
        .lb-close, .lb-refresh{
            border:0; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:700;
            transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
        }
        .lb-refresh{ background: var(--accent-blue); color:#0c1130; }
        .lb-close{ background: #3d3d60; color:#fff; }
        .lb-refresh:hover{ transform: translateY(-1px); box-shadow: 0 8px 18px rgba(139,233,253,.22); }
        .lb-close:hover{ transform: translateY(-1px); box-shadow: 0 8px 18px rgba(0,0,0,.35); }
        @media (max-width: 420px){
            .lb-title{ font-size:1.05em; }
            table.lb-table th, table.lb-table td{ padding:9px 10px; }
        }

    </style>
</head>
<body>
    <div class="container">
        <div id="introSection" class="centered-page">
            <h1><i class="fa-solid fa-envelope-open-text"></i> Phishing Crisis Simulation</h1>
            <p style="max-width: 600px;">Welcome, new Head of Cyber Threat Intelligence at COLHAK Technology! Your company is developing a groundbreaking AI-based product. However, a rival group is launching a multi-layered spear-phishing attack to steal intellectual property. This attack isn't limited to emails—it's supported by LinkedIn, WhatsApp, and phone calls. Your mission: Detect anomalous behavior and protect the company against this insidious attack!</p>
            <img src="intro.png" alt="A cyber security themed intro image" class="scenario-image">

            <div class="intro-info-grid">
                <div class="intro-roles-container">
                    <h3><i class="fa-solid fa-people-arrows"></i> Simulation Roles</h3>
                    <ul>
                        <li><span class="icon"><i class="fa-solid fa-user-shield"></i></span><div><strong>Your Role: Head of Cyber Threat Intelligence</strong> <small>You are responsible for detecting, analyzing, and managing the crisis against multi-channel phishing attacks.</small></div></li>
                        <li><span class="icon"><i class="fa-solid fa-users-gear"></i></span><div><strong>CEO Elara Yılmaz</strong> <small>Focused on the company's reputation and launch.</small></div></li>
                        <li><span class="icon"><i class="fa-solid fa-user-tie"></i></span><div><strong>CSO Can Demir</strong> <small>Responsible for cybersecurity.</small></div></li>
                        <li><span class="icon"><i class="fa-solid fa-user-group"></i></span><div><strong>HR Director Ayşe Erdem</strong> <small>Focused on employee morale and productivity.</small></div></li>
                        <li><span class="icon"><i class="fa-solid fa-money-bill-transfer"></i></span><div><strong>Finance Director Burak Mert</strong> <small>Responsible for budget and finance.</small></div></li>
                        <li><span class="icon"><i class="fa-solid fa-microchip"></i></span><div><strong>R&D Director Deniz Akın</strong> <small>Lead developer of the AI product.</small></div></li>
                        <li><span class="icon"><i class="fa-solid fa-server"></i></span><div><strong>IT System Admin Mert Can</strong> <small>Responsible for network and system health.</small></div></li>
                    </ul>
                </div>
                <div class="intro-metrics-container">
                    <h3><i class="fa-solid fa-chart-line"></i> Key Metrics</h3>
                    <ul>
                        <li><span class="icon" style="color: var(--accent-green);"><i class="fa-solid fa-square-check"></i></span><div><strong>Intellectual Property Integrity</strong> <small>Security of the AI project data. (Start: 100%)</small></div></li>
                        <li><span class="icon" style="color: var(--accent-red);"><i class="fa-solid fa-hand-holding-dollar"></i></span><div><strong>Financial Loss</strong> <small>The cost of the crisis to the company. (Start: $0)</small></div></li>
                        <li><span class="icon" style="color: var(--accent-yellow);"><i class="fa-solid fa-users"></i></span><div><strong>Employee Trust</strong> <small>Staff's faith in the company and management. (Start: 100)</small></div></li>
                        <li><span class="icon" style="color: var(--accent-blue);"><i class="fa-solid fa-building-shield"></i></span><div><strong>Reputation Score</strong> <small>Your company's image in the public and industry. (Start: 100)</small></div></li>
                    </ul>
                </div>
            </div>
            <button class="btn btn-start" id="startButton"><i class="fa-solid fa-play"></i> Start Simulation</button>
        </div>

        <div id="intermissionSection" class="centered-page" style="display: none;">
            <h2 id="intermissionTitle"></h2>
            <div id="intermissionDetails">
            </div>
            <button class="btn btn-continue" id="continueButton" style="margin-top: 30px; display: none;"><i class="fa-solid fa-forward"></i> Continue</button>
        </div>

        <div id="gameContainer" style="display: none;">
            <div id="statusBar">
                <div class="metric"><span><i class="fa-solid fa-lock"></i> IP Integrity</span><div class="value" id="status-ipIntegrity">100%</div></div>
                <div class="metric"><span><i class="fa-solid fa-hand-holding-dollar"></i> Financial Loss</span><div class="value" id="status-financialLoss">$0</div></div>
                <div class="metric"><span><i class="fa-solid fa-users"></i> Employee Trust</span><div class="value" id="status-employeeTrust">100</div></div>
                <div class="metric"><span><i class="fa-solid fa-building-shield"></i> Reputation</span><div class="value" id="status-reputation">100</div></div>
                <div class="metric" id="status-timer"><span><i class="fa-solid fa-stopwatch"></i> Time Left</span><div class="value" id="status-remaining">05:00</div></div>
            </div>
            <div id="game-content">
            </div>
        </div>
    </div>

    <div class="lb-overlay" id="leaderboardOverlay" role="dialog" aria-modal="true" aria-labelledby="lbTitle">
        <div class="lb-modal">
            <div class="lb-header">
                <h2 id="lbTitle" class="lb-title"><i class="fa-solid fa-trophy"></i> Leaderboard</h2>
                <span class="lb-sub">Phishing Simulation Top Scores</span>
            </div>
            <div class="lb-tablewrap">
                <table class="lb-table" id="leaderboardTable">
                    <thead>
                        <tr><th>#</th><th>Name</th><th>Score</th><th>Date</th></tr>
                    </thead>
                    <tbody id="leaderboardBody">
                        <tr><td colspan="4">Loading…</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="lb-actions">
                <button class="lb-refresh" id="lbRefreshBtn"><i class="fa-solid fa-arrows-rotate"></i> Refresh</button>
                <button class="lb-close" id="lbCloseBtn">Close</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            window.game = {
                score: { ipIntegrity: 100, financialLoss: 0, employeeTrust: 100, reputation: 100 },
                state: {
                    currentSectionId: 'start',
                    emailAnalyzed: false, linkedinProfileAnalyzed: false, awarenessTrainingInitiated: false, threatHuntingStarted: false,
                    whatsappForensicallyExamined: false, vishingAnalyzed: false, personnelInterviewed: false, internalNetworkMonitored: false,
                    malwareAnalyzed: false, systemsIsolated: false, cemilConfronted: false, insiderThreatReported: false, usomCollaboration: false,
                    crisisMeetingHeld: false, publicStatementPrepared: false, externalForensicHired: false, cemilManaged: false,
                    protocolsRevised: false, ipSecurityEnhanced: false, reputationCampaignLaunched: false, employeeSupportInitiated: false, insiderThreatProgramStarted: false,
                    decisionHistory: [],
                    currentTurnDecisions: [],
                    totalScore: null,
                },

                elements: {},
                
                timer: {
                    total: 300,
                    remaining: 300,
                    intervalId: null,
                    running: false
                },
                
                decisionInfo: {
                    'd1-m-email-analysis': {
                        title: "Detailed Analysis of CEO's Email",
                        text: "You technically analyzed the email from the CEO. You understood the primary attack vector by detecting the malicious link/attachment. The file contained a dropper.",
                        strat: "Early technical analysis in phishing attacks is essential to break the chain. Speed minimizes damage.",
                        changes: { financialLoss: 5000, ipIntegrity: -2, employeeTrust: -1 },
                        clue: 'emailAnalyzed',
                        impact: 'Positive',
                    },
                    'd1-m-linkedin-analysis': {
                        title: "LinkedIn Profile Analysis and OSINT",
                        text: "You analyzed the LinkedIn profile and message. A fake profile and a credential harvesting portal URL were detected. You understood the attacker's social engineering capabilities.",
                        strat: "In social engineering, OSINT is valuable for understanding the attacker's preparation. Following the redirects is critical.",
                        changes: { financialLoss: 2000, ipIntegrity: -1, employeeTrust: -1, reputation: -1 },
                        clue: 'linkedinProfileAnalyzed',
                        impact: 'Neutral',
                    },
                    'd1-m-awareness-training': {
                        title: "Urgent Cyber Awareness Training",
                        text: "You requested urgent phishing and social engineering awareness training from HR. The announcement was made, and the program was planned. This can increase employee resilience in the long run.",
                        strat: "Employee awareness is the strongest defense against attacks targeting human vulnerability. The impact of training may not be immediate.",
                        changes: { financialLoss: 10000, employeeTrust: +5, reputation: -2 },
                        clue: 'awarenessTrainingInitiated',
                        impact: 'Neutral',
                    },
                    'd1-m-threat-hunting': {
                        title: "Urgent Threat Hunting",
                        text: "You reported to the CSO and initiated a comprehensive threat hunt. This created an opportunity to detect potential breaches early, but it required intensive resources.",
                        strat: "Proactive threat hunting is effective in detecting unknown attacks, but it can be costly and requires planning.",
                        changes: { financialLoss: 25000, ipIntegrity: -3, reputation: -3 },
                        clue: 'threatHuntingStarted',
                        impact: 'Negative',
                    },
                    'd1-a-whatsapp-forensics': {
                        title: "Forensic Examination of WhatsApp Account",
                        text: "You put the WhatsApp account under forensic examination. You discovered that the attacker used internal jargon and specific project information, indicating an insider leak.",
                        strat: "Examining messaging apps is essential to understand the attacker's methods. Suspicion of an insider leak is strengthened.",
                        changes: { financialLoss: 15000, ipIntegrity: -3 },
                        clue: 'whatsappForensicallyExamined',
                        impact: 'Negative',
                    },
                    'd1-a-vishing-analysis': {
                        title: "Phone Call Recording Analysis (Vishing)",
                        text: "You analyzed the phone call recordings. You deciphered the attacker's vishing tactics and that they were questioning sensitive project information. This raised suspicion of an insider source.",
                        strat: "Vishing analysis improves defense against future attacks. It's critical not to overlook signs of an insider threat.",
                        changes: { financialLoss: 10000, ipIntegrity: -5 },
                        clue: 'vishingAnalyzed',
                        impact: 'Negative',
                    },
                    'd1-a-personnel-interviews': {
                        title: "Security Interviews with Targeted Personnel",
                        text: "You conducted one-on-one interviews with key personnel. You understood the attacker's manipulation techniques. The anxiety and financial troubles of an employee named Cemil Kaan caught your attention, strengthening the possibility of an insider leak.",
                        strat: "Human intelligence (HUMINT) is vital for understanding cyber crises from an employee's perspective. A careful and empathetic approach is needed.",
                        changes: { employeeTrust: -5, reputation: -3, financialLoss: 3000 },
                        clue: 'personnelInterviewed',
                        impact: 'Neutral',
                    },
                    'd1-a-network-monitoring': {
                        title: "Internal Network Traffic and Log Monitoring",
                        text: "You started real-time monitoring of network traffic and logs. It was discovered that Cemil Kaan made an abnormal number of access attempts to the critical 'Project AI' folder. This was a serious sign of a breach.",
                        strat: "Network monitoring and log analysis are fundamental for detecting internal movements in advanced attacks. Observing abnormal access to critical assets is vital.",
                        changes: { financialLoss: 40000, ipIntegrity: -8, reputation: -2 },
                        clue: 'internalNetworkMonitored',
                        impact: 'Negative',
                    },
                    'd2-m-malware-full-analysis': {
                        title: "Malware Reverse Engineering and C2 Detection",
                        text: "You sent the malware to the reverse engineering team. They determined that the software created a backdoor, accessed 'Project AI', and exfiltrated data to an external C2 server. The attacker's target and infrastructure were exposed, reinforcing the insider threat suspicion.",
                        strat: "Malware analysis and C2 detection are critical for understanding the technical mechanism of an attack. It provides essential information for effective countermeasures.",
                        changes: { financialLoss: 30000, ipIntegrity: -10, reputation: -5 },
                        clue: 'malwareAnalyzed',
                        impact: 'Negative',
                    },
                    'd2-m-system-isolation': {
                        title: "Urgent Isolation of Critical Systems",
                        text: "You immediately cut off external access to the 'Project AI' folder and isolated critical development environments. You largely prevented data leakage, but the development process was disrupted and operational costs increased.",
                        strat: "Protecting critical data is a priority. Suspect systems should be isolated quickly; this may affect business continuity but protects assets.",
                        changes: { financialLoss: 50000, ipIntegrity: +15, reputation: -8, employeeTrust: -5 },
                        clue: 'systemsIsolated',
                        impact: 'Positive',
                    },
                    'd2-m-confront-cemil': {
                        title: "Confrontation and Confession from Cemil Kaan",
                        text: "You confronted Cemil Kaan in a private meeting. He confessed to being manipulated and persuaded to install malware in the 'Project AI' folder. The incident was clarified, but employee trust was shaken.",
                        strat: "Confronting insider threats is risky but important for gathering information. The approach should focus on collecting intelligence and consider the impact on reputation/trust.",
                        changes: { financialLoss: 5000, employeeTrust: -15, reputation: -10, ipIntegrity: +8 },
                        clue: 'cemilConfronted',
                        impact: 'Negative',
                    },
                    'd2-m-report-insider-threat': {
                        title: "Report Insider Threat Suspicion to Management and Legal",
                        text: "You reported all insider threat findings to the Legal department and the CEO. By requesting legal counsel, you expedited the process, but internal tensions increased.",
                        strat: "Involving legal and management processes in insider threats minimizes risks. A balance between transparency and confidentiality is important.",
                        changes: { financialLoss: 10000, employeeTrust: -7, reputation: -4 },
                        clue: 'insiderThreatReported',
                        impact: 'Neutral',
                    },
                    'd2-m-usom-collaboration': {
                        title: "Inform the National Cyber Incident Response Center (USOM)",
                        text: "Suspecting the attack could be state-sponsored, you informed USOM. USOM stated they would provide support. You received national-level assistance, but there was a short-term negative impact on your image.",
                        strat: "In state-sponsored attacks, collaboration with national units provides additional resources. The potential impacts of information sharing must be evaluated.",
                        changes: { financialLoss: 5000, reputation: -7, ipIntegrity: +3 },
                        clue: 'usomCollaboration',
                        impact: 'Neutral',
                    },
                    'd2-a-crisis-team-meeting': {
                        title: "Comprehensive Crisis Team Meeting",
                        text: "You gathered all key stakeholders for an emergency crisis meeting. The nature of the attack, Cemil's situation, and the intellectual property threat were communicated. Coordination increased, and panic decreased.",
                        strat: "In cyber crises, effective communication and collaboration enable fast and effective crisis management. Transparency is important, no matter how harsh the facts are.",
                        changes: { financialLoss: 5000, reputation: +5, employeeTrust: +2 },
                        clue: 'crisisMeetingHeld',
                        impact: 'Positive',
                    },
                    'd2-a-public-statement-draft': {
                        title: "Draft a Proactive Public Statement",
                        text: "You prepared a proactive and detailed draft public statement with the Public Relations and Legal departments. To protect the company's reputation, the sophisticated nature of the attack and proactive steps were emphasized. There is a risk of short-term public shock.",
                        strat: "Public communication in a crisis directly affects company reputation. A balanced, transparent statement is crucial. Controlled dissemination of information is essential.",
                        changes: { financialLoss: 10000, reputation: +2, employeeTrust: -3 },
                        clue: 'publicStatementPrepared',
                        impact: 'Neutral',
                    },
                    'd2-a-external-forensic-legal': {
                        title: "Engage External Cyber Forensics and Legal Support",
                        text: "Due to the complexity of the attack, you requested urgent assistance from an independent cyber forensics and law firm. This accelerated the investigation and made the findings impartial, but the cost was very high.",
                        strat: "In complex attacks, external expertise enhances crisis management capacity and provides evidence for legal processes. Costs must be managed well.",
                        changes: { financialLoss: 150000, reputation: +3, ipIntegrity: +5 },
                        clue: 'externalForensicHired',
                        impact: 'Positive',
                    },
                    'd2-a-cemil-management': {
                        title: "Managing the Cemil Kaan Situation",
                        text: "Following Cemil Kaan's confession, you collaborated with HR and Legal to provide him with psychological support and requested he sign a non-disclosure agreement. You managed the situation by protecting the employee's reputation and gathering information. The humane approach reflected positively on the company culture.",
                        strat: "Managing the human aspect of insider threats is important for ethics and corporate culture. Support and confidentiality can increase company loyalty and security in the long run.",
                        changes: { financialLoss: 8000, employeeTrust: +4, reputation: -2 },
                        clue: 'cemilManaged',
                        impact: 'Positive',
                    },
                    'd3-m-protocol-revision-ai-training': {
                        title: "Multi-Channel Security Protocols and AI-Powered Awareness Training",
                        text: "You tightened security protocols across all communication channels. You made employees more resilient with AI-powered phishing simulations and behavioral analysis-based awareness training. The company's overall security posture was strengthened.",
                        strat: "Defense against multi-channel attacks considers both technical and human behaviors. AI-powered training increases adaptation.",
                        changes: { financialLoss: 70000, reputation: +10, employeeTrust: +7, ipIntegrity: +5 },
                        clue: 'protocolsRevised',
                        impact: 'Positive',
                    },
                    'd3-m-ip-security-enhancement': {
                        title: "Comprehensive Enhancement of AI Project's IP Security",
                        text: "You implemented additional security layers (DAC, MAC, DLP, IRM) for the AI project's codebase, algorithms, and datasets. You set up automated systems to continuously monitor access to critical data. You protected your most valuable asset.",
                        strat: "Protecting critical intellectual property secures the most important asset. It requires a continuous, layered, and technology-supported security approach.",
                        changes: { financialLoss: 100000, ipIntegrity: +20, reputation: +5 },
                        clue: 'ipSecurityEnhanced',
                        impact: 'Positive',
                    },
                    'd3-m-reputation-campaign': {
                        title: "Proactive Reputation Management and Transparency Campaign",
                        text: "You launched a proactive reputation management campaign with full transparency to the public, emphasizing that the attack is a common problem in the industry. You significantly strengthened the company's reputation and reinforced your leadership in cybersecurity.",
                        strat: "Public communication in a crisis directly affects company reputation. A balanced, transparent statement is crucial. Turning crises into opportunities is strategic.",
                        changes: { financialLoss: 120000, reputation: +15, employeeTrust: +5},
                        clue: 'reputationCampaignLaunched',
                        impact: 'Positive',
                    },
                    'd3-m-employee-support': {
                        title: "Employee Psychological Support and Trust Rebuilding Programs",
                        text: "You launched psychological support and morale-boosting activities to mitigate the negative effects on employees. You helped employees regain their trust and increase their commitment. Internal resilience was strengthened.",
                        strat: "The well-being and security of employees are the foundation of company resilience. Rebuilding morale and trust after a crisis is vital. A human-centric approach is critical.",
                        changes: { financialLoss: 30000, employeeTrust: +10, reputation: +2},
                        clue: 'employeeSupportInitiated',
                        impact: 'Positive',
                    },
                    'd3-m-insider-threat-program': {
                        title: "Establishment of an Insider Threat Intelligence Program and Security Culture Integration",
                        text: "You developed behavioral analysis tools, risk assessments, and ethically framed monitoring policies to proactively detect insider threats. You integrated this with a strong security culture. You minimized vulnerabilities from internal sources in the long term.",
                        strat: "Insider threat programs are vital for managing one of the most challenging cyber risks. Ethical and transparent execution protects employee trust. Security culture integration guarantees success.",
                        changes: { financialLoss: 80000, employeeTrust: -5, ipIntegrity: +15, reputation: +7 },
                        clue: 'insiderThreatProgramStarted',
                        impact: 'Positive',
                    }
                },

                setup() {
                    this.elements = {
                        intro: document.getElementById('introSection'), game: document.getElementById('gameContainer'), gameContent: document.getElementById('game-content'),
                        startButton: document.getElementById('startButton'), intermission: document.getElementById('intermissionSection'),
                        intermissionTitle: document.getElementById('intermissionTitle'), intermissionDetails: document.getElementById('intermissionDetails'),
                        continueButton: document.getElementById('continueButton'),
                        statusBar: { 
                            ipIntegrity: document.getElementById('status-ipIntegrity'), 
                            financialLoss: document.getElementById('status-financialLoss'), 
                            employeeTrust: document.getElementById('status-employeeTrust'), 
                            reputation: document.getElementById('status-reputation'),
                            remaining: document.getElementById('status-remaining')
                        },
                        leaderboard: {
                            overlay: document.getElementById('leaderboardOverlay'),
                            body: document.getElementById('leaderboardBody'),
                            btnClose: document.getElementById('lbCloseBtn'),
                            btnRefresh: document.getElementById('lbRefreshBtn'),
                            btnOpen: document.querySelector('#finalSection .decision-buttons #openLeaderboardBtn')
                        }
                    };
                    this.loadGameHTML();
                    this.attachListeners();
                },
                
                attachListeners() {
                     // Start button
                    this.elements.startButton.addEventListener('click', () => {
                        this.elements.intro.style.display = 'none';
                        this.elements.game.style.display = 'block';
                        this.startGlobalTimer();
                        this.showSection('day1_morning_phishing');
                    });
                    
                    // Decision buttons in game content
                    this.elements.gameContent.addEventListener('click', (e) => {
                        const button = e.target.closest('.btn[data-decision]');
                        if (!button || button.disabled) return;
                        
                        const sectionElement = button.closest('.section');
                        const decisionId = button.dataset.decision;
                        const info = this.decisionInfo[decisionId];

                        button.disabled = true;
                        this.state.currentTurnDecisions.push(info);
                        
                        this.score.financialLoss += info.changes.financialLoss || 0;
                        this.score.reputation = Math.max(0, Math.min(100, this.score.reputation + (info.changes.reputation || 0)));
                        this.score.ipIntegrity = Math.max(0, Math.min(100, this.score.ipIntegrity + (info.changes.ipIntegrity || 0)));
                        this.score.employeeTrust = Math.max(0, Math.min(100, this.score.employeeTrust + (info.changes.employeeTrust || 0)));
                        this.state[info.clue] = true;
                        this.updateStatusBar();

                        const maxSelections = parseInt(sectionElement.dataset.maxSelections || 1, 10);
                        
                        if (this.state.currentSectionId === 'day1_afternoon_phishing') {
                            this.elements.game.style.display = 'none';
                            this.state.currentTurnDecisions.forEach(decision => {
                                this.state.decisionHistory.push({ id: decision.clue, title: decision.title, text: decision.text, impactType: decision.impact });
                            });
                            this.state.currentTurnDecisions = [];
                            this.showSection('day1_evening_phishing');
                        } else if (this.state.currentTurnDecisions.length >= maxSelections) {
                            this.elements.game.style.display = 'none';
                            this.showFullIntermission();
                        } else {
                            this.updateButtonStates(this.state.currentSectionId); 
                        }
                    });

                    // General continue button
                    this.elements.continueButton.addEventListener('click', () => {
                        this.state.currentTurnDecisions.forEach(decision => {
                            this.state.decisionHistory.push({ id: decision.clue, title: decision.title, text: decision.text, impactType: decision.impact });
                        });

                        const nextPath = this.elements.continueButton.dataset.nextPath;
                        this.elements.intermission.style.display = 'none';
                        this.elements.continueButton.style.display = 'none';

                        this.state.currentTurnDecisions = [];
                        
                        if (nextPath === 'finalSection') {
                            this.showFinalReport();
                        } else {
                            this.elements.game.style.display = 'block';
                            this.showSection(nextPath);
                        }
                    });

                    // Leaderboard listeners
                    this.elements.leaderboard.btnOpen?.addEventListener('click', () => this.openLeaderboard());
                    this.elements.leaderboard.btnClose?.addEventListener('click', () => this.closeLeaderboard());
                    this.elements.leaderboard.btnRefresh?.addEventListener('click', () => this.loadLeaderboard());
                    this.elements.leaderboard.overlay.addEventListener('click', (e) => {
                        if (e.target === this.elements.leaderboard.overlay) this.closeLeaderboard();
                    });

                    this.updateStatusBar();
                },

                showFullIntermission() {
                    this.elements.intermissionDetails.innerHTML = ''; // Clear previous details

                    let totalChanges = { financialLoss: 0, ipIntegrity: 0, employeeTrust: 0, reputation: 0 };
                    let combinedDecisionTitles = [];
                    let combinedDecisionTexts = [];
                    let combinedStrategicNotes = [];

                    this.state.currentTurnDecisions.forEach((info) => {
                        totalChanges.financialLoss += info.changes.financialLoss || 0;
                        totalChanges.ipIntegrity += info.changes.ipIntegrity || 0;
                        totalChanges.employeeTrust += info.changes.employeeTrust || 0;
                        totalChanges.reputation += info.changes.reputation || 0;
                        
                        combinedDecisionTitles.push(info.title);
                        combinedDecisionTexts.push(info.text);
                        combinedStrategicNotes.push(info.strat);
                    });

                    this.elements.intermissionTitle.textContent = "Total Impact of These Choices"; 
                    
                    this.elements.intermissionDetails.insertAdjacentHTML('afterbegin', `
                        <div class="metric-change-summary-container">
                            <div class="metric-change-summary">
                                ${this.getMetricsHtml(totalChanges)}
                            </div>
                        </div>
                    `);

                    this.elements.intermissionDetails.insertAdjacentHTML('beforeend', `
                        <div class="interactive-element" style="width: 100%; max-width: 600px; margin-top: 30px;">
                            <h4><i class="fa-solid fa-check-circle"></i> Details of Your Choices: ${combinedDecisionTitles.join(' & ')}</h4>
                            <p>${combinedDecisionTexts.join('<br><br>')}</p>
                            <div class="interactive-element" style="border-left-color: var(--accent-blue); margin-top: 20px;">
                                <h4>Strategic Assessment</h4>
                                <p>${combinedStrategicNotes.join('<br><br>')}</p>
                            </div>
                        </div>
                    `);

                    let nextSectionToGo;
                    switch(this.state.currentSectionId) {
                        case 'day1_morning_phishing': nextSectionToGo = 'day1_afternoon_phishing'; break;
                        case 'day1_evening_phishing': nextSectionToGo = 'day2_morning_ipthreat'; break;
                        case 'day2_morning_ipthreat': nextSectionToGo = 'day2_afternoon_crisis_mgmt'; break;
                        case 'day2_afternoon_crisis_mgmt': nextSectionToGo = 'day3_morning_resolution'; break;
                        case 'day3_morning_resolution': nextSectionToGo = 'finalSection'; break; 
                        default: nextSectionToGo = 'finalSection'; break;
                    }

                    this.elements.continueButton.dataset.nextPath = nextSectionToGo;
                    this.elements.intermission.style.display = 'flex';
                    this.elements.continueButton.style.display = 'flex';
                },

                getMetricsHtml(changes) {
                    let metricsHTML = '';
                    const formatChange = (label, value, unit) => {
                        const arrow = value >= 0 ? (value > 0 ? 'up' : 'right') : 'down'; 
                        const sign = value >= 0 ? '+' : ''; 
                        let colorClass = 'neutral'; 

                        if (label === 'Financial Loss') {
                            colorClass = value > 0 ? 'negative' : (value < 0 ? 'positive' : 'neutral');
                        } else {
                            colorClass = value > 0 ? 'positive' : (value < 0 ? 'negative' : 'neutral');
                        }
                        
                        let icon = '';
                        if (label === 'Financial Loss') icon = 'fa-sack-xmark';
                        else if (label === 'IP Integrity') icon = 'fa-lock';
                        else if (label === 'Employee Trust') icon = 'fa-users';
                        else if (label === 'Reputation') icon = 'fa-building-shield';

                        return `<div class="metric-change ${colorClass}"><i class="fa-solid ${icon}"></i> ${label}: <i class="fa-solid fa-arrow-${arrow}-long"></i> ${sign}${Math.abs(value).toLocaleString('en-US')}${unit}</div>`;
                    };

                    if (changes.financialLoss !== undefined && changes.financialLoss !== 0) metricsHTML += formatChange('Financial Loss', changes.financialLoss, '$');
                    if (changes.ipIntegrity !== undefined && changes.ipIntegrity !== 0) metricsHTML += formatChange('IP Integrity', changes.ipIntegrity, '%');
                    if (changes.employeeTrust !== undefined && changes.employeeTrust !== 0) metricsHTML += formatChange('Employee Trust', changes.employeeTrust, '');
                    if (changes.reputation !== undefined && changes.reputation !== 0) metricsHTML += formatChange('Reputation', changes.reputation, '');
                    
                    if (metricsHTML === '') metricsHTML = '<p style="text-align: center; font-size: 1.1em; opacity: 0.8;">These decisions had no direct impact on the metrics.</p>';
                    return metricsHTML;
                },

                updateStatusBar() {
                    const s = this.score;
                    this.elements.statusBar.ipIntegrity.textContent = `${Math.max(0, s.ipIntegrity)}%`;
                    this.elements.statusBar.financialLoss.textContent = `$${s.financialLoss.toLocaleString('en-US')}`;
                    this.elements.statusBar.employeeTrust.textContent = Math.max(0, s.employeeTrust);
                    this.elements.statusBar.reputation.textContent = Math.max(0, s.reputation);
                },

                showSection(sectionId) {
                    this.elements.sections.forEach(section => { section.style.display = 'none'; });
                    const targetSection = document.getElementById(sectionId);
                    if (targetSection) {
                        targetSection.style.display = 'block';
                        this.state.currentSectionId = sectionId;
                        this.updateDynamicContent(sectionId);
                        this.updateButtonStates(sectionId);
                        this.state.currentTurnDecisions = []; // Reset for new section
                        
                        const day1AfternoonContinueBtn = document.querySelector('#day1_afternoon_phishing .btn-continue');
                        if (day1AfternoonContinueBtn) {
                            day1AfternoonContinueBtn.style.display = (sectionId === 'day1_afternoon_phishing') ? 'flex' : 'none';
                        }
                        this.elements.continueButton.style.display = 'none'; 

                    } else {
                        console.error('Section not found:', sectionId);
                        this.showFinalReport();
                    }
                    this.updateSlackChat(sectionId);
                },

                updateButtonStates(sectionId) {
                    const currentSectionElement = document.getElementById(sectionId);
                    if (!currentSectionElement) return;

                    const decisionButtonsContainer = currentSectionElement.querySelector('.decision-buttons');
                    if (!decisionButtonsContainer) {
                        return; 
                    }

                    const buttons = decisionButtonsContainer.querySelectorAll('.btn[data-decision]');
                    buttons.forEach(button => {
                        const decisionId = button.dataset.decision;
                        const info = this.decisionInfo[decisionId];

                        const alreadySelectedInCurrentTurn = this.state.currentTurnDecisions.some(d => d.clue === info.clue);

                        if (info && (this.state[info.clue] || alreadySelectedInCurrentTurn)) {
                            button.disabled = true;
                        } else {
                            button.disabled = false;
                        }

                        if (decisionId === 'd2-a-cemil-management') {
                            if (!this.state.cemilConfronted) {
                                button.disabled = true;
                                button.querySelector('small').textContent = 'This option is only available if you have confronted Cemil Kaan and obtained his confession.';
                                button.style.cursor = 'not-allowed';
                            } else if (!alreadySelectedInCurrentTurn) {
                                button.disabled = false;
                                button.querySelector('small').textContent = 'Initiate an urgent confidentiality agreement and psychological support process for Cemil Kaan with HR and Legal.';
                                button.style.cursor = 'pointer';
                            }
                        }
                    });
                },
                
                showFinalReport() {
                    this.stopGlobalTimer();
                    this.elements.intro.style.display = 'none';
                    this.elements.intermission.style.display = 'none';
                    this.elements.game.style.display = 'block'; 
                    document.getElementById('statusBar').style.display = 'none';

                    this.elements.sections.forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    const finalSection = document.getElementById('finalSection');
                    if (!finalSection) { console.error("Final section not found in HTML!"); return; }

                    finalSection.style.display = 'flex';
                    
                    const badge = document.getElementById('performance-badge');
                    const metricsContainer = document.getElementById('finalMetricsContainer');
                    const timelineList = document.getElementById('decision-timeline-list');
                    const debriefContent = document.getElementById('strategic-debrief-content');
                    const scoreBreakdownList = document.getElementById('score-breakdown');

                    // --- REVISED AND BALANCED SCORING SYSTEM ---
                    let scoreBreakdown = {};
                    let totalScore = 40; 
                    scoreBreakdown['Starting Score'] = { value: 40, class: 'score-neutral' };
                    
                    let decisionQualityScore = 0;
                    this.state.decisionHistory.forEach(decision => {
                        if (decision.impactType === 'Negative') {
                            decisionQualityScore -= 10;
                        } else if (decision.impactType === 'Positive') {
                            decisionQualityScore += 3;
                        }
                    });
                    if (decisionQualityScore !== 0) {
                        totalScore += decisionQualityScore;
                        scoreBreakdown['Decision Quality (Penalty/Bonus)'] = { value: decisionQualityScore, class: decisionQualityScore >= 0 ? 'score-plus' : 'score-minus' };
                    }
                    
                    const finalIP = Math.max(0, this.score.ipIntegrity);
                    const finalRep = Math.max(0, this.score.reputation);
                    const finalTrust = Math.max(0, this.score.employeeTrust);
                    const avgRepTrust = (finalRep + finalTrust) / 2;

                    // IP Integrity
                    if (finalIP >= 90) { totalScore += 15; scoreBreakdown['IP Protection (Excellent)'] = { value: 15, class: 'score-plus' }; }
                    else if (finalIP >= 70) { totalScore += 8; scoreBreakdown['IP Protection (Good)'] = { value: 8, class: 'score-plus' }; }
                    else if (finalIP < 50) { totalScore -= 15; scoreBreakdown['IP Loss (Serious)'] = { value: -15, class: 'score-minus' }; }
                    
                    // Financial Loss
                    if (this.score.financialLoss <= 150000) { totalScore += 15; scoreBreakdown['Financial Management (Effective)'] = { value: 15, class: 'score-plus' }; }
                    else if (this.score.financialLoss <= 300000) { totalScore += 5; scoreBreakdown['Financial Management (Moderate)'] = { value: 5, class: 'score-plus' }; }
                    else if (this.score.financialLoss > 500000) { totalScore -= 20; scoreBreakdown['Financial Loss (High)'] = { value: -20, class: 'score-minus' }; }

                    // Reputation & Trust
                    if (avgRepTrust >= 80) { totalScore += 15; scoreBreakdown['Reputation & Trust Mgmt (Strong)'] = { value: 15, class: 'score-plus' }; }
                    else if (avgRepTrust < 40) { totalScore -= 15; scoreBreakdown['Reputation & Trust Loss (High)'] = { value: -15, class: 'score-minus' }; }

                    // Critical Decisions Bonus
                    if(this.state.systemsIsolated) { totalScore += 7; scoreBreakdown['Critical Decision: System Isolation'] = { value: 7, class: 'score-plus' }; }
                    if(this.state.cemilConfronted && this.state.cemilManaged) { totalScore += 7; scoreBreakdown['Critical Decision: Insider Threat Mgmt'] = { value: 7, class: 'score-plus' }; }
                    if(this.state.usomCollaboration) { totalScore += 3; scoreBreakdown['Strategic Decision: USOM Collab.'] = { value: 3, class: 'score-plus' }; }
                    if(this.state.reputationCampaignLaunched) { totalScore += 5; scoreBreakdown['Strategic Decision: Reputation Campaign'] = { value: 5, class: 'score-plus' }; }

                    // Time Bonus
                    if (this.timer.remaining >= 120) { totalScore += 10; scoreBreakdown['Rapid Response Bonus'] = { value: 10, class: 'score-plus' }; } 
                    else if (this.timer.remaining >= 60) { totalScore += 5; scoreBreakdown['Timely Response Bonus'] = { value: 5, class: 'score-plus' }; }

                    totalScore = Math.round(Math.max(0, Math.min(100, totalScore))); 
                    this.state.totalScore = totalScore;

                    let badgeInfo = {};
                    if (totalScore >= 95) { badgeInfo = { text: 'CYBER HERO', color: 'var(--accent-green)' }; } 
                    else if (totalScore >= 80) { badgeInfo = { text: 'EXPERT CRISIS MANAGER', color: 'var(--accent-blue)' }; } 
                    else if (totalScore >= 60) { badgeInfo = { text: 'A TOUGH CHALLENGE', color: 'var(--accent-yellow)' }; } 
                    else { badgeInfo = { text: 'SIGNIFICANT DAMAGE', color: '#ff5555' }; }

                    badge.textContent = badgeInfo.text;
                    badge.style.backgroundColor = badgeInfo.color;

                    metricsContainer.innerHTML = `
                        <div class="metric-card"><div class="icon"><i class="fa-solid fa-file-invoice-dollar"></i></div><div class="label">Final Score</div><div class="value">${totalScore}/100</div></div>
                        <div class="metric-card"><div class="icon"><i class="fa-solid fa-building-shield"></i></div><div class="label">Reputation Score</div><div class="value">${finalRep}/100</div></div>
                        <div class="metric-card"><div class="icon"><i class="fa-solid fa-hand-holding-dollar"></i></div><div class="label">Financial Loss</div><div class="value">$${this.score.financialLoss.toLocaleString('en-US')}</div></div>
                        <div class="metric-card"><div class="icon"><i class="fa-solid fa-lock"></i></div><div class="label">IP Integrity</div><div class="value">${finalIP}%</div></div>
                        <div class="metric-card"><div class="icon"><i class="fa-solid fa-users"></i></div><div class="label">Employee Trust</div><div class="value">${finalTrust}/100</div></div>
                    `;

                    timelineList.innerHTML = this.state.decisionHistory.map(decision => {
                        let liClass = decision.impactType === 'Positive' ? 'positive' : (decision.impactType === 'Negative' ? 'negative' : 'neutral');
                        return `<li class="${liClass}"><span class="decision-title">${decision.title}</span></li>`;
                    }).join('');

                    scoreBreakdownList.innerHTML = Object.entries(scoreBreakdown).map(([key, item]) => {
                        const sign = item.value > 0 ? '+' : '';
                        return `<li class="${item.class}"><span>${key}</span><span class="score-value">${sign}${item.value} Points</span></li>`;
                    }).join('');

                    let debriefHTML = '';
                    if (badgeInfo.text === 'CYBER HERO') { 
                        debriefHTML += `<p><strong>Outstanding Success!</strong> As a Head of Cyber Threat Intelligence, you expertly detected this sophisticated multi-channel attack at every layer, saving your company from a major disaster. With your strategic and swift decisions, you not only protected our intellectual property but also elevated our company's reputation and employee trust to new heights. Thanks to your leadership, COLHAK Technology has emerged stronger from this crisis.</p>`;
                    } else if (badgeInfo.text === 'EXPERT CRISIS MANAGER') { 
                        debriefHTML += `<p><strong>A Successful Response!</strong> Despite facing a highly complex attack, you successfully brought the crisis under control with effective interventions. Although there were some minor losses, you largely preserved your company's intellectual property, reputation, and employee trust. The decisions you made have enabled COLHAK Technology to learn from this challenging process and become more resilient.</p>`;
                    } else if (badgeInfo.text === 'A TOUGH CHALLENGE') { 
                        debriefHTML += `<p><strong>Major Lessons Learned:</strong> You managed the crisis and averted the worst-case scenario, but you were unable to completely prevent some of the attack's impacts. We experienced partial losses of our intellectual property, incurred financial damages, and the company's reputation was somewhat tarnished. This experience has provided important lessons for improving our future cybersecurity strategies.</p>`;
                    } else { 
                        debriefHTML += `<p><strong>Serious Consequences:</strong> The multi-channel phishing attack has caused significant damage to COLHAK Technology. There were major leaks of our intellectual property, financial losses are very high, and our company's reputation is severely damaged. Employee trust has been shattered. We must urgently learn from this experience, radically change our security strategies, and build stronger defense mechanisms.</p>`;
                    }
                    debriefContent.innerHTML = debriefHTML;
                    this.saveLeaderboard(totalScore);
                },

                updateSlackChat(currentSection) {
                    const chatViewer = document.getElementById('slackChat');
                    if (!chatViewer) return; 

                    let chat = '';
                    if (currentSection === 'day1_afternoon_phishing') {
                        chat = `
                            <div class="message"><span class="sender hr">HR Director Ayşe Erdem:</span> There's growing unrest among employees. We're getting a lot of questions about WhatsApp and phone messages. Morale is dropping.</div>
                            <div class="message"><span class="sender ceo">CEO Elara Yılmaz:</span> This is unacceptable! There should be no leaks about the AI project! What kind of information are we talking about?</div>
                            <div class="message"><span class="sender finance">Finance Dir. Burak Mert:</span> If our budget details leak, our funding will be seriously harmed. We must stop this!</div>
                            <div class="message"><span class="sender cso">CSO Can Demir:</span> Our teams are investigating the threats. The Head of CTI's findings are valuable. We are collecting additional logs for anomaly detection.</div>
                            <div class="message"><span class="sender">You (Head of CTI):</span> It's a multi-channel attack, and it seems they have an insider. Every piece of information is critical, we must focus.</div>
                        `;
                    } else if (currentSection === 'day2_morning_ipthreat') {
                        chat = `
                            <div class="message"><span class="sender ops">R&D Director Deniz Akın:</span> Anomaly alarms in our codebase are increasing! Data transfers are at a critical level! Immediate action required!</div>
                            <div class="message"><span class="sender cso">CSO Can Demir:</span> Cemil Kaan's activities are suspicious. We're monitoring him, but we must be quick. Prevent the leak!</div>
                            <div class="message"><span class="sender ceo">CEO Elara Yılmaz:</span> An insider threat?! This will do huge damage to our image. We must stop it at all costs!</div>
                            <div class="message"><span class="sender finance">Finance Dir. Burak Mert:</span> Our project budget is sensitive, any disruption will lead to major losses. Is our data secure?</div>
                            <div class="message"><span class="sender bt">IT Admin Mert Can:</span> We are ready for isolation, but shutting down the production environment will cause serious outages.</div>
                            <div class="message"><span class="sender">You (Head of CTI):</span> The target is our intellectual property! We must act immediately! Cemil's situation is also a priority.</div>
                        `;
                    } else if (currentSection === 'day2_afternoon_crisis_mgmt') { 
                        chat = `
                            <div class="message"><span class="sender ceo">CEO Elara Yılmaz:</span> Cemil's confession is shocking. What now? How will we make a public statement? Has the IP been recovered?</div>
                            <div class="message"><span class="sender hr">HR Director Ayşe Erdem:</span> Our employees' morale is low. Cemil's situation is creating uncertainty. We must restore internal peace.</div>
                            <div class="message"><span class="sender finance">Finance Dir. Burak Mert:</span> The legal and financial consequences of this crisis could be dire. Is external expert support necessary?</div>
                            <div class="message"><span class="sender cso">CSO Can Demir:</span> Technical interventions are ongoing. Communication and crisis management are as important as the technical response.</div>
                            <div class="message"><span class="sender ops">R&D Director Deniz Akın:</span> We've isolated the data leak, but we're not sure how much information got out. The project launch is at risk.</div>
                            <div class="message"><span class="sender">You (Head of CTI):</span> Coordination is crucial. With every department's contribution, we will get through this crisis with minimal damage. It's time to make the right decisions.</div>
                        `;
                    } else if (currentSection === 'day3_morning_resolution') { 
                        chat = `
                            <div class="message"><span class="sender ceo">CEO Elara Yılmaz:</span> That was terrifying, but we survived. How do we move forward now? We must turn this crisis into an opportunity.</div>
                            <div class="message"><span class="sender hr">HR Director Ayşe Erdem:</span> Our employees are exhausted. Keeping morale high and ensuring their trust is our priority. Training and support are essential.</div>
                            <div class="message"><span class="sender finance">Finance Dir. Burak Mert:</span> We need a clear roadmap for financial recovery and investments. What about the cybersecurity budget?</div>
                            <div class="message"><span class="sender cso">CSO Can Demir:</span> We must completely rebuild our defense mechanisms. Cyber Threat Intelligence will play a key role. Proactive defense is indispensable.</div>
                            <div class="message"><span class="sender ops">R&D Director Deniz Akın:</span> The security of our AI project is paramount. We must strengthen our intellectual property. This attack showed our vulnerabilities.</div>
                            <div class="message"><span class="sender">You (Head of CTI):</span> The intelligence we've gathered will shape our future strategy. We must learn from this crisis to build a stronger COLHAK Technology.</div>
                        `;
                    }
                    chatViewer.innerHTML = chat;
                },

                updateDynamicContent(sectionId) {
                    const section = document.getElementById(sectionId);
                    if (!section) return;

                    if (sectionId === 'day2_afternoon_crisis_mgmt') {
                        const cemilStatusSpan = section.querySelector('#cemil-status');
                        if (cemilStatusSpan) {
                            if (game.state.cemilConfronted) {
                                cemilStatusSpan.innerHTML = '<strong>it has been confirmed that Cemil Kaan was manipulated or leaked information from within.</strong>';
                            } else {
                                cemilStatusSpan.innerHTML = 'there is suspicion of an insider "mole" or a manipulated employee.';
                            }
                        }
                    }
                },

                loadGameHTML() {
                    const gameHTMLContent = `
                        <div id="day1_morning_phishing" class="section" data-max-selections="2">
                            <h2><i class="fa-solid fa-hourglass-start"></i> Day 1: Morning - The Multi-Channel Threat Begins</h2>
                            <h3>09:00 AM - First Signals</h3>
                            <p>As you start the new week as Head of CTI, disturbing signals from multiple sources are setting off **alarm bells**.</p>
                            <p><strong>Incident 1: Strange Email from the CEO</strong><br>You received a suspicious email from CEO Elara Yılmaz with an attachment named 'Project_AI_Optimization_V3.pdf'. Grammatical errors and a slight typo in the sender's address (<code>.com</code> instead of <code>.co</code>) are noticeable. Is this a targeted phishing attempt?</p>
                            <p><strong>Incident 2: Odd Job Offer on LinkedIn</strong><br>R&D engineer Ozan Demirci reported receiving a "very attractive" job offer on LinkedIn. The offer allegedly comes from the "Global R&D Director" of a rival company. Although the profile looks professional, some details seem strange to Ozan, and he is directed to a special portal.</p>
                            <img src="linkedin.png" alt="Suspicious email and LinkedIn message" class="scenario-image">
                            <div class="interactive-element">
                                <h4>As the Head of Cyber Threat Intelligence, what will be your first steps? How will you handle these two different vectors? (Make 2 choices)</h4>
                                <div class="decision-buttons">
                                    <button class="btn" data-decision="d1-m-email-analysis"><i class="fa-solid fa-envelope-open-text"></i><div class="btn-text">Option A: Submit the suspicious CEO email for technical analysis.<small>Conduct an in-depth review for malicious links and attachments.</small></div></button>
                                    <button class="btn" data-decision="d1-m-linkedin-analysis"><i class="fa-brands fa-linkedin"></i><div class="btn-text">Option B: Analyze the LinkedIn profile and the message sent to the engineer.<small>Use OSINT tools to determine if it's fake and analyze the redirect link.</small></div></button>
                                    <button class="btn" data-decision="d1-m-awareness-training"><i class="fa-solid fa-user-graduate"></i><div class="btn-text">Option C: Request urgent cyber awareness training and announcements from HR.<small>Initiate awareness training for staff on phishing and social engineering attacks.</small></div></button>
                                    <button class="btn" data-decision="d1-m-threat-hunting"><i class="fa-solid fa-magnifying-glass"></i><div class="btn-text">Option D: Report to the CSO and recommend an urgent "Threat Hunting" operation.<small>Initiate similar threat hunting activities across the network, email systems, and endpoints.</small></div></button>
                                </div>
                            </div>
                            <div class="learning-note"><strong>Learning Note:</strong> In multi-channel attacks, each vector exploits a different vulnerability. The initial response is critical to prevent spread and understand the scope.</div>
                        </div>

                        <div id="day1_afternoon_phishing" class="section" data-max-selections="0">
                            <h2><i class="fa-solid fa-comments"></i> Day 1: Afternoon - The Threat Deepens</h2>
                            <h3>02:30 PM - New Vectors</h3>
                            <p>As the results of your morning interventions come in, you realize the attackers are not limited to just email and LinkedIn.</p>
                            <p><strong>Incident 1: Critical Data Request via WhatsApp</strong><br>A finance employee received a request for 'Project AI Budget Details' on WhatsApp from someone impersonating a former colleague. The use of company-specific jargon in the message is a strong sign of **an insider leak**.</p>
                            <p><strong>Incident 2: Vishing (Voice Phishing) Attempt</strong><br>R&D Director Deniz Akın reported a strange phone call from someone claiming to be from 'technical support'. During the call, technical details of the AI project were questioned, strengthening the suspicion of **an insider source**.</p>
                            <div class="slack-chat" id="slackChat"></div>
                            <button class="btn btn-continue" onclick="game.showSection('day1_evening_phishing')" style="margin-top: 30px;">Continue</button>
                        </div>

                        <div id="day1_evening_phishing" class="section" data-max-selections="2">
                            <h2><i class="fa-solid fa-cloud-moon"></i> Day 1: Evening - Intelligence Gathering and Response Strategy</h2>
                            <h3>06:00 PM - Insider Suspicions and Decisions</h3>
                            <img src="tespit.png" alt="WhatsApp and phone call screenshots" class="scenario-image">
                            <div class="interactive-element">
                                <h4>What intelligence gathering and response strategy will you follow against these new and deepening attack vectors? (Make 2 choices)</h4>
                                <div class="decision-buttons">
                                    <button class="btn" data-decision="d1-a-whatsapp-forensics"><i class="fa-brands fa-whatsapp"></i><div class="btn-text">Option A: Initiate a forensic examination of the WhatsApp account.<small>Identify the attacker's information gathering and trust-building tactics.</small></div></button>
                                    <button class="btn" data-decision="d1-a-vishing-analysis"><i class="fa-solid fa-phone-volume"></i><div class="btn-text">Option B: Analyze the phone call recordings.<small>Decipher the vishing tactics and investigate the suspicion of an insider source.</small></div></button>
                                    <button class="btn critical" data-decision="d1-a-personnel-interviews"><i class="fa-solid fa-user-tie"></i><div class="btn-text">Option C: Conduct one-on-one security interviews with key targeted personnel.<small>Understand the attacker's manipulation techniques and look for signs of an insider leak.</small></div></button>
                                    <button class="btn" data-decision="d1-a-network-monitoring"><i class="fa-solid fa-chart-network"></i><div class="btn-text">Option D: Start monitoring internal network traffic and logs.<small>Proactively detect abnormal access to critical folders.</small></div></button>
                                </div>
                            </div>
                            <div class="learning-note"><strong>Learning Note:</strong> Attackers use different channels to gain trust and gather information. An insider leak is one of the biggest threats; each channel has its own detection method.</div>
                        </div>

                        <div id="day2_morning_ipthreat" class="section" data-max-selections="2">
                            <h2><i class="fa-solid fa-fingerprint"></i> Day 2: Morning - IP Threat and Insider Alarm</h2>
                            <h3>10:00 AM - AI Project in Danger! Suspicion on Cemil Kaan!</h3>
                            <p>If the email analysis was done, the analysis of the malware in the email to the CEO is complete. The software was found to be trying to access the **'Project AI' folder**. This indicates that the intellectual property was targeted. The LinkedIn, WhatsApp, and phone calls were efforts to gain personnel trust for this access.</p>
                            <p>The most alarming development: If you conducted personnel interviews or internal network monitoring, it was revealed that **Cemil Kaan from the Finance Department made abnormal access attempts to a critical folder he normally doesn't have access to** at the beginning of the crisis. There are also rumors about Cemil's financial difficulties and rival job offers.</p>
                            <img src="risk.png" alt="AI project data leak risk" class="scenario-image">
                            <div class="interactive-element">
                                <h4>What will be your most critical actions to protect the intellectual property, stop the attack, and manage the insider threat? (Make 2 choices)</h4>
                                <div class="decision-buttons">
                                    <button class="btn" data-decision="d2-m-malware-full-analysis"><i class="fa-solid fa-bug-slash"></i><div class="btn-text">Option A: Analyze all capabilities of the malware and its C2 servers in detail.<small>Fully understand the attacker's infrastructure and intent.</small></div></button>
                                    <button class="btn critical" data-decision="d2-m-system-isolation"><i class="fa-solid fa-lock-open"></i><div class="btn-text">Option B: Cut off all external access to the 'Project AI' folder and immediately isolate related systems.<small>Take immediate, radical action to stop the data leak.</small></div></button>
                                    <button class="btn critical" data-decision="d2-m-confront-cemil"><i class="fa-solid fa-user-secret"></i><div class="btn-text">Option C: Arrange a private meeting with Cemil Kaan and confront him about his suspicious activities.<small>Gather information by asking him direct questions.</small></div></button>
                                    <button class="btn" data-decision="d2-m-report-insider-threat"><i class="fa-solid fa-gavel"></i><div class="btn-text">Option D: Submit a report to the Legal department and senior management about the suspected insider leak.<small>Request legal counsel and get advice on possible legal proceedings.</small></div></button>
                                    <button class="btn" data-decision="d2-m-usom-collaboration"><i class="fa-solid fa-shield-halved"></i><div class="btn-text">Option E: Inform the National Cyber Incident Response Center (USOM).<small>Report the situation as a suspected state-sponsored attack and request collaboration.</small></div></button>
                                </div>
                            </div>
                            <div class="learning-note"><strong>Learning Note:</strong> Intellectual property theft and insider threats can be devastating. A swift and correct response is key. Ethical and legal boundaries are important when dealing with insider threats.</div>
                        </div>

                        <div id="day2_afternoon_crisis_mgmt" class="section" data-max-selections="2">
                            <h2><i class="fa-solid fa-lightbulb"></i> Day 2: Afternoon - Crisis Management and Decision-Making (High Pressure)</h2>
                            <h3>03:30 PM - Crisis Team Under Pressure</h3>
                            <p>The details of the attack are becoming clear: Your AI project's intellectual property is under serious threat, and <span id="cemil-status">${game.state.cemilConfronted ? '<strong>it has been confirmed that Cemil Kaan was manipulated or leaked information from within.</strong>' : 'there is suspicion of an insider "mole" or a manipulated employee.'}</span> The CEO wants quick action and a clear message. The Finance Director is concerned about legal processes and losses. The HR Director emphasizes employee morale and trust.</p>
                            <img src="team.png" alt="Crisis management team" class="scenario-image">
                            <div class="interactive-element">
                                <h4>What strategic decisions will you make at this stage of the crisis? (Make 2 choices)</h4>
                                <div class="decision-buttons">
                                    <button class="btn" data-decision="d2-a-crisis-team-meeting"><i class="fa-solid fa-people-group"></i><div class="btn-text">Option A: Gather all key stakeholders for an emergency crisis meeting.<small>Communicate the multi-channel nature of the attack and the insider threat situation (if any), and strengthen coordination.</small></div></button>
                                    <button class="btn critical" data-decision="d2-a-public-statement-draft"><i class="fa-solid fa-bullhorn"></i><div class="btn-text">Option B: Draft a public statement with the Public Relations and Legal departments.<small>Prepare a transparent statement emphasizing the sophisticated nature of the attack and proactive steps to protect reputation.</small></div></button>
                                    <button class="btn" data-decision="d2-a-external-forensic-legal"><i class="fa-solid fa-gavel"></i><div class="btn-text">Option C: Request urgent help from external cyber forensics and law firms.<small>Accelerate the investigation, prepare for legal proceedings, and ensure the impartiality of the findings (high cost).</small></div></button>
                                    <button class="btn" data-decision="d2-a-cemil-management" ${game.state.cemilConfronted ? '' : 'disabled'}><i class="fa-solid fa-user-shield"></i><div class="btn-text">Option D: Manage the Cemil Kaan situation with HR and Legal.<small>Initiate a confidentiality agreement and psychological support process for Cemil. (Only available if you have confronted Cemil Kaan).</small></div></button>
                                </div>
                            </div>
                            <div class="learning-note"><strong>Learning Note:</strong> Crisis management is not just about technical solutions. Communication, legal compliance, and stakeholder management determine the overall outcome of the crisis.</div>
                        </div>

                        <div id="day3_morning_resolution" class="section" data-max-selections="2">
                            <h2><i class="fa-solid fa-check-circle"></i> Day 3: Morning - Recovery and Future Strategies</h2>
                            <h3>11:00 AM - Post-Crisis Recovery</h3>
                            <p>The most intense phase of the incident is over. The scope and impact of the attack have been understood ${game.state.cemilConfronted ? 'and the Cemil Kaan situation has been addressed.' : '.'} COLHAK Technology needs to learn from this experience and become more resilient to future cyber threats. Protecting intellectual property, restoring employee trust, and repairing the company's reputation are priorities. As the Head of Cyber Threat Intelligence, your task is to turn lessons learned into concrete action plans and propose a long-term security strategy.</p>
                            <img src="kurtarma.png" alt="Recovery and healing efforts" class="scenario-image">
                            <div class="interactive-element">
                                <h4>What long-term strategies will you propose for your company's future cyber resilience? (Make 2 choices)</h4>
                                <div class="decision-buttons">
                                    <button class="btn" data-decision="d3-m-protocol-revision-ai-training"><i class="fa-solid fa-lock"></i><div class="btn-text">Option A: Multi-Channel Security Protocols and AI-Powered Awareness Training.<small>Tighten security protocols on communication channels and make employees resilient with AI-powered phishing simulations.</small></div></button>
                                    <button class="btn" data-decision="d3-m-ip-security-enhancement"><i class="fa-solid fa-shield-alt"></i><div class="btn-text">Option B: Comprehensive Enhancement of AI Project's IP Security.<small>Implement additional security layers (DAC, MAC, DLP, IRM) for critical AI project data and set up continuous monitoring systems.</small></div></button>
                                    <button class="btn critical" data-decision="d3-m-reputation-campaign"><i class="fa-solid fa-handshake-angle"></i><div class="btn-text">Option C: Proactive Reputation Management and Transparency Campaign.<small>Launch a proactive reputation management campaign with full transparency, emphasizing that the attack is an industry-wide problem.</small></div></button>
                                    <button class="btn" data-decision="d3-m-employee-support"><i class="fa-solid fa-people-robotic"></i><div class="btn-text">Option D: Employee Psychological Support, Trust Rebuilding, and Internal Communication Programs.<small>Launch comprehensive psychological support and internal communication programs to mitigate the negative impact of the crisis on employees.</small></div></button>
                                    <button class="btn" data-decision="d3-m-insider-threat-program"><i class="fa-solid fa-user-check"></i><div class="btn-text">Option E: Establish an Insider Threat Intelligence Program and Integrate it with Security Culture.<small>Set up an Insider Threat Intelligence Program with advanced behavioral analysis tools, risk assessments, and ethical monitoring policies.</small></div></button>
                                </div>
                            </div>
                            <div class="learning-note"><strong>Learning Note:</strong> Post-crisis recovery isn't just about technical fixes. Enhancing corporate security, boosting employee morale, and managing public reputation are vital for long-term success.</div>
                        </div>

                        <div id="finalSection" class="section centered-page" style="display: none;">
                            <h2><i class="fa-solid fa-chart-line"></i> Post-Crisis Evaluation Report</h2>
                            <p>The simulation is complete. Below is a detailed breakdown of your crisis management performance.</p>
                            <div id="performance-badge-container"><span id="performance-badge"></span></div>
                            <div class="final-metrics" id="finalMetricsContainer"></div>
                            <div class="post-crisis-layout">
                                <div class="event-timeline">
                                    <h3><i class="fa-solid fa-timeline"></i> Decision Timeline</h3>
                                    <ul id="decision-timeline-list"></ul>
                                </div>
                                <div class="strategic-debrief">
                                    <h3><i class="fa-solid fa-lightbulb"></i> Strategic Debrief</h3>
                                    <div id="strategic-debrief-content"></div>
                                    <h3 style="margin-top: 20px;"><i class="fa-solid fa-calculator"></i> Score Breakdown</h3>
                                    <ul id="score-breakdown"></ul>
                                </div>
                            </div>
                            <div class="decision-buttons" style="margin-top: 40px; display:flex; gap:12px; flex-wrap:wrap; justify-content:center;">
                                <button class="btn btn-start" onclick="location.reload()"><i class="fa-solid fa-arrow-rotate-right"></i> Restart Simulation</button>
                                <button class="btn" id="openLeaderboardBtn"><i class="fa-solid fa-trophy"></i> Leaderboard</button>
                            </div>
                        </div>
                    `;
                    this.elements.gameContent.innerHTML = gameHTMLContent;
                    this.elements.sections = this.elements.gameContent.querySelectorAll('.section');
                    this.elements.leaderboard.btnOpen = document.getElementById('openLeaderboardBtn');
                    this.elements.leaderboard.btnOpen?.addEventListener('click', () => this.openLeaderboard());

                    hljs.highlightAll();
                },

                startGlobalTimer() {
                    if (this.timer.running) return;
                    this.timer.running = true;
                    this.timer.remaining = this.timer.total;
                    this.updateTimerUI();
                    this.timer.intervalId = setInterval(() => {
                        this.timer.remaining--;
                        this.updateTimerUI();
                        if (this.timer.remaining <= 0) {
                            this.stopGlobalTimer();
                            alert("Time's up! Generating report.");
                            this.showFinalReport();
                        }
                    }, 1000);
                },

                stopGlobalTimer() {
                    if (this.timer.intervalId) clearInterval(this.timer.intervalId);
                    this.timer.intervalId = null;
                    this.timer.running = false;
                },

                updateTimerUI() {
                    const m = String(Math.floor(this.timer.remaining / 60)).padStart(2,'0');
                    const s = String(this.timer.remaining % 60).padStart(2,'0');
                    if (this.elements.statusBar.remaining) {
                        this.elements.statusBar.remaining.textContent = `${m}:${s}`;
                    }
                },

                openLeaderboard() {
                    this.elements.leaderboard.overlay.style.display = 'flex';
                    this.loadLeaderboard();
                },

                closeLeaderboard() {
                    this.elements.leaderboard.overlay.style.display = 'none';
                },

                async saveLeaderboard(finalScore) {
                    let name = localStorage.getItem('playerName');
                    if (!name || name.trim() === '') {
                        name = prompt("Enter your name for the leaderboard:", "Anonymous");
                        if (!name || name.trim() === '') name = 'Anonymous';
                        localStorage.setItem('playerName', name);
                    }
                    
                    const payload = {
                        scenario: 'v5-phishing',
                        name: name.toString().slice(0, 40),
                        score: finalScore,
                        details: {
                            ipIntegrity: this.score.ipIntegrity,
                            financialLoss: this.score.financialLoss,
                            employeeTrust: this.score.employeeTrust,
                            reputation: this.score.reputation,
                            decisions: this.state.decisionHistory.map(d => d.id)
                        },
                        timeSpentSec: this.timer.total - this.timer.remaining,
                        timestamp: new Date().toISOString()
                    };

                    try {
                        const res = await fetch('/api/score', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!res.ok) throw new Error('API request failed: ' + res.status);
                    } catch(e) {
                        console.warn("Could not reach API. Saving score locally.");
                        const key = 'leaderboard-v5-phishing';
                        const arr = JSON.parse(localStorage.getItem(key) || '[]');
                        arr.push(payload);
                        arr.sort((a,b)=> b.score - a.score);
                        localStorage.setItem(key, JSON.stringify(arr.slice(0,100)));
                    }
                },

                async loadLeaderboard() {
                    const tbody = this.elements.leaderboard.body;
                    const key = 'leaderboard-v5-phishing';
                    tbody.innerHTML = `<tr><td colspan="4">Loading…</td></tr>`;
                    let rows = [];
                    try {
                        const res = await fetch('/api/leaderboard?scenario=v5-phishing', { method:'GET' });
                        if (!res.ok) throw new Error('API request failed: ' + res.status);
                        const data = await res.json();
                        rows = Array.isArray(data) ? data : [];
                    } catch(e) {
                        console.warn("Could not reach API. Loading leaderboard from local storage.");
                        const arr = JSON.parse(localStorage.getItem(key) || '[]');
                        rows = arr.map(x => ({ name: x.name, score: x.score, timestamp: x.timestamp }));
                    }

                    if (!rows.length) {
                        tbody.innerHTML = `<tr><td colspan="4">No entries yet.</td></tr>`;
                        return;
                    }
                    
                    rows.sort((a,b)=> b.score - a.score);
                    tbody.innerHTML = rows.slice(0,50).map((r,i)=>`
                        <tr>
                            <td>${i+1}</td>
                            <td>${(r.name || 'Anonymous').toString().slice(0,40)}</td>
                            <td>${r.score}</td>
                            <td>${r.timestamp ? new Date(r.timestamp).toLocaleString('en-US') : '-'}</td>
                        </tr>
                    `).join('');
                }
            };
            window.game.setup();
        });
    </script>
</body>
</html>

